<!DOCTYPE html>
<html lang="zh-CN">
<head><!-- hexo injector head_begin start -->
<link rel="stylesheet" href="/css/bilicard.css?v=372a94e93f">
<!-- hexo injector head_begin end -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Android, Cache, Cleaner, System Cache">
    <meta name="description" content="Android 系统缓存从原理探索到实现。">
    <meta name="author" content="Pin Young">
    
    <title>
        
            Android 系统缓存扫描与清理方法分析 |
        
        零域
    </title>
    
<link rel="stylesheet" href="/css/style.css?v=512d6d2336">

    <link rel="shortcut icon" href="/img/favicon.png?v=96e789c5be">
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css?v=d318f67430">

    
<link rel="stylesheet" href="/font/css/regular.min.css?v=dd643a612d">

    
<link rel="stylesheet" href="/font/css/solid.min.css?v=4abb638a78">

    
<link rel="stylesheet" href="/font/css/brands.min.css?v=bffe02773a">

    
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"0skyu.cn","root":"/","language":"zh-CN","path":"search.xml"}
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#EE5A24","logo":"/img/favicon.png?v=96e789c5be","favicon":"/img/favicon.png?v=96e789c5be","avatar":"img/1.jpg","font_size":null,"font_family":null,"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"header_transparent":false,"background_img":"/img/bg/333.jpg?v=7b42f26db7","description":"Keep writing and Keep loving.","font_color":"#f0d21a","hitokoto":true},"scroll":{"progress_bar":true,"percent":false}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":false,"use":"gitalk","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":"DsTansice","github_admins":"DsTansice","repository":"Null-Comment","client_id":"b109b534b2268088d780","client_secret":"7808e138a1ffbcd9f02bb39cc1ee7fb41828c52f","proxy":null},"twikoo":{"env_id":"twikoo-0skyucn-1gkzaji32bb03146","region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml?v=59074eec35" title="零域" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/img/favicon.png?v=96e789c5be">
                </a>
            
            <a class="logo-title" href="/">
               零域
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class href="/">
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class href="/archives">
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class href="/tags">
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class href="/categories">
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class href="/links">
                                友链
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class target="_blank" rel="noopener" href="https://hao.0skyu.cn/">
                                HAO
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class href="/links">友链</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class target="_blank" rel="noopener" href="https://hao.0skyu.cn/">HAO</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">Android 系统缓存扫描与清理方法分析</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/img/1.jpg?v=e52bd9a478">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Pin Young</span>
                            
                                <span class="author-label">Lv9</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2021-03-28 00:00:00</span>
        <span class="mobile">2021-03-28 00:00</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-02-05 21:25:09</span>
    </span>
    
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Android/">Android</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>5.5k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>25 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <p>本文记录的是我对 Android 的「系统缓存」及其扫描和清理方法的探索与理解。</p>
<p>本文讲述内容的完整代码实例见 <a class="link" target="_blank" rel="noopener" href="https://github.com/mzlogin/CleanExpert">https://github.com/mzlogin/CleanExpert<i class="fas fa-external-link-alt"></i></a>。</p>
<h2 id="系统缓存的定义"><a href="#系统缓存的定义" class="headerlink" title="系统缓存的定义"></a>系统缓存的定义</h2><p>如下是我捏造的非官方定义：</p>
<p><strong>系统缓存：</strong> Android APP 在运行过程中保存在手机内置和外置存储上的缓存文件总和。</p>
<h2 id="系统缓存的组成"><a href="#系统缓存的组成" class="headerlink" title="系统缓存的组成"></a>系统缓存的组成</h2><p>先说结论：</p>
<p><strong>「系统缓存」由所有已安装应用的 /data/data/packagename/cache 文件夹和 /sdcard/Android/data/packagename/cache 文件夹组成。</strong></p>
<p>如下是原理分析，不感兴趣的可以直接跳到<a href="#%E7%B3%BB%E7%BB%9F%E7%BC%93%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%9A%84%E8%AE%A1%E7%AE%97">下一节</a>。</p>
<p>我们先来看一个熟悉的界面：</p>
<p><img lazyload alt="image" data-src="/images/posts/android/installed-app-details.png"></p>
<p>这是手机的「设置」——「应用」里的已安装应用的详情页，这里面会显示缓存的大小，而且提供了清理缓存的功能，这就是我们做「系统缓存」清理想做的事情。</p>
<p>这里显示的大小是如何计算出来的，它实际上的文件组成是怎么样的呢？可以从 Android 系统自带的 Settings APP 的源码中找到答案。</p>
<p><em>注：下面的分析基于我手边的 Android 4.1 源码，比较古老了，但并不妨碍理解。</em></p>
<h3 id="探索「外部缓存」"><a href="#探索「外部缓存」" class="headerlink" title="探索「外部缓存」"></a>探索「外部缓存」</h3><p>按惯例先说结论：</p>
<p><strong>「外部缓存」由所有已安装应用的 /sdcard/Android/data/packagename/cache 文件夹组成。</strong></p>
<p>Settings APP 的源码在 Android 源码树的 packages/apps/Settings 目录里，在它里面能找到 InstalledAppDetails.java 文件，从名字上看它应该就是对应我们上图中的「应用详情页」，它是一个 Fragment，在它的 <code>onResume</code> 方法中调用了 <code>refreshUi</code> 方法，它里面又调用了 <code>refreshSizeInfo</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshSizeInfo</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">if</span> (mAppEntry.size == ApplicationsState.SIZE_INVALID</span><br><span class="line">            || mAppEntry.size == ApplicationsState.SIZE_UNKNOWN) {</span><br><span class="line">        ......</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        ......</span><br><span class="line">        <span class="type">long</span> <span class="variable">cacheSize</span> <span class="operator">=</span> mAppEntry.cacheSize + mAppEntry.externalCacheSize;</span><br><span class="line">        <span class="keyword">if</span> (mLastCacheSize != cacheSize) {</span><br><span class="line">            mLastCacheSize = cacheSize;</span><br><span class="line">            mCacheSize.setText(getSizeStr(cacheSize));</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个方法定义在文件 packages/apps/Settings/src/com/android/settings/applications/InstalledAppDetails.java 中。</p>
<p>很显然这里的 <code>cacheSize</code> 就是对应上图里的缓存大小，从这几行代码的字面意义里可以看出缓存是由「内部缓存」加「外部缓存」组成，甚至可以初步推测出本节的结论，当然我是一个严谨的人，继续深究一下其中的原理。</p>
<p>找到给 <code>mAppEntry</code> 赋值的地方：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">refreshUi</span><span class="params">()</span> {</span><br><span class="line">    ......</span><br><span class="line">    mAppEntry = mState.getEntry(packageName);</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个方法定义在文件 packages/apps/Settings/src/com/android/settings/applications/InstalledAppDetails.java 中。</p>
<p>继续看 <code>getEntry</code> 里做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AppEntry <span class="title function_">getEntry</span><span class="params">(String packageName)</span> {</span><br><span class="line">    ......</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;mApplications.size(); i++) {</span><br><span class="line">                <span class="type">ApplicationInfo</span> <span class="variable">info</span> <span class="operator">=</span> mApplications.get(i);</span><br><span class="line">                <span class="keyword">if</span> (packageName.equals(info.packageName)) {</span><br><span class="line">                    entry = getEntryLocked(info);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">    .......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个方法定义在文件 packages/apps/Settings/src/com/android/settings/applications/ApplicationsState.java 中。</p>
<p>找到给 <code>mApplications</code> 添加数据的地方：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addPackage</span><span class="params">(String pkgName)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">synchronized</span> (mEntriesMap) {</span><br><span class="line">            ......</span><br><span class="line">            <span class="type">ApplicationInfo</span> <span class="variable">info</span> <span class="operator">=</span> mPm.getApplicationInfo(pkgName,</span><br><span class="line">                    PackageManager.GET_UNINSTALLED_PACKAGES |</span><br><span class="line">                    PackageManager.GET_DISABLED_COMPONENTS);</span><br><span class="line">            mApplications.add(info);</span><br><span class="line">            <span class="keyword">if</span> (!mBackgroundHandler.hasMessages(BackgroundHandler.MSG_LOAD_ENTRIES)) {</span><br><span class="line">                mBackgroundHandler.sendEmptyMessage(BackgroundHandler.MSG_LOAD_ENTRIES);</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (NameNotFoundException e) {</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个方法定义在文件 packages/apps/Settings/src/com/android/settings/applications/ApplicationsState.java 中。</p>
<p>它在 <code>mApplications.add(info);</code> 后顺便发了个消息，经过 <code>MSG_LOAD_ENTRIES</code> 到 <code>MSG_LOAD_ICONS</code> 到 <code>MSG_LOAD_SIZES</code> 的消息链，我们看到一个从名字上就看出来很重要的关键方法调用 <code>getPackageSizeInfo</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BackgroundHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> {</span><br><span class="line">    ......</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> {</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) {</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">case</span> MSG_LOAD_ENTRIES: {</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (numDone &gt;= <span class="number">6</span>) {</span><br><span class="line">                    ......</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    sendEmptyMessage(MSG_LOAD_ICONS);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_LOAD_ICONS: {</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (numDone &gt;= <span class="number">2</span>) {</span><br><span class="line">                    ......</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    sendEmptyMessage(MSG_LOAD_SIZES);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_LOAD_SIZES: {</span><br><span class="line">                <span class="keyword">synchronized</span> (mEntriesMap) {</span><br><span class="line">                    ......</span><br><span class="line">                                mPm.getPackageSizeInfo(mCurComputingSizePkg, mStatsObserver);</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个类定义在文件 packages/apps/Settings/src/com/android/settings/applications/ApplicationsState.java 中。</p>
<p><code>mPm</code> 是 <code>PackageManager</code> 类型的，这是一个抽象类型，它的实现类为 <code>ApplicationPackageManager</code>，<code>ApplicationPackageManager.getPackageSizeInfo</code> 里调用了 <code>IPackageManager.getPackageSizeInfo</code>，<code>IPackageManager</code> 的实例在 <code>ContexImpl.getPackageManager</code> 方法里通过 <code>ActivityThread.getPackageManager()</code> 获得，它的方法调用最终是反映到通过 Binder 机制返回的 <code>PackageManagerService</code> 实例上，我们找到 <code>getPackageSizeInfo</code> 的最终实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PackageManagerService</span> <span class="keyword">extends</span> <span class="title class_">IPackageManager</span>.Stub {</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPackageSizeInfo</span><span class="params">(<span class="keyword">final</span> String packageName,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> IPackageStatsObserver observer)</span> {</span><br><span class="line">        ......</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(INIT_COPY);</span><br><span class="line">        msg.obj = <span class="keyword">new</span> <span class="title class_">MeasureParams</span>(stats, observer);</span><br><span class="line">        mHandler.sendMessage(msg);</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个方法定义在文件 frameworks/base/services/java/com/android/server/pm/PackageManagerService.java 中。</p>
<p>这里我们注意 <code>msg.obj</code> 的类型为 <code>MeasureParams</code>，<code>INIT_COPY</code> 消息对应的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PackageHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">mBound</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> {</span><br><span class="line">        ......</span><br><span class="line">            doHandleMessage(msg);</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doHandleMessage</span><span class="params">(Message msg)</span> {</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) {</span><br><span class="line">            <span class="keyword">case</span> INIT_COPY: {</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (!mBound) {</span><br><span class="line">                    <span class="keyword">if</span> (!connectToService()) {</span><br><span class="line">                        ......</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        ......</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">case</span> MCS_BOUND: {</span><br><span class="line">                ......</span><br><span class="line">                        <span class="keyword">if</span> (params.startCopy()) {</span><br><span class="line">                            ......</span><br><span class="line">                        }</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个类定义在文件 frameworks/base/services/java/com/android/server/pm/PackageManagerService.java 中。</p>
<p><code>mBound</code> 默认值为 false，所以会进 <code>connectToService</code> 方法，里面会触发 <code>DefaultContainerConnection.onServiceConnected</code> 回调，发送了 <code>MCS_BOUND</code> 的消息，通过 <code>params.startCopy()</code> 来到 <code>MeasureParams</code> 的 <code>handleStartCopy</code> 方法里，可以直接看到 <code>externalCacheSize</code> 的计算方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException {</span><br><span class="line">    <span class="keyword">synchronized</span> (mInstallLock) {</span><br><span class="line">        mSuccess = getPackageSizeInfoLI(mStats.packageName, mStats);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mounted) {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">File</span> <span class="variable">externalCacheDir</span> <span class="operator">=</span> Environment</span><br><span class="line">                .getExternalStorageAppCacheDirectory(mStats.packageName);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">externalCacheSize</span> <span class="operator">=</span> mContainerService</span><br><span class="line">                .calculateDirectorySize(externalCacheDir.getPath());</span><br><span class="line">        mStats.externalCacheSize = externalCacheSize;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个方法定义在文件 frameworks/base/services/java/com/android/server/pm/PackageManagerService.java 中。</p>
<p><code>externalCacheSize</code> 实际即是 <code>Environment.getExternalStorageAppCacheDirectory</code> 返回的文件夹的大小，来看一下它返回的文件夹是什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Environment</span> {</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">File</span> <span class="variable">EXTERNAL_STORAGE_ANDROID_DATA_DIRECTORY</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">            getDirectory(<span class="string">"EXTERNAL_STORAGE"</span>, <span class="string">"/storage/sdcard0"</span>), <span class="string">"Android"</span>), <span class="string">"data"</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> File <span class="title function_">getExternalStorageAppCacheDirectory</span><span class="params">(String packageName)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="keyword">new</span> <span class="title class_">File</span>(EXTERNAL_STORAGE_ANDROID_DATA_DIRECTORY,</span><br><span class="line">                packageName), <span class="string">"cache"</span>);</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个类定义在文件 frameworks/base/core/java/android/os/Environment.java 中。</p>
<p>一般来讲 /storage/sdcard0 都是挂载到 /sdcard，可见 <code>Environment.getExternalStorageAppCacheDirectory</code> 返回的就是 /sdcard/Android/data/packagename/cache。</p>
<p>即有小结论一：</p>
<p><strong>「外部缓存」由所有已安装应用的 /sdcard/Android/data/packagename/cache 文件夹组成。</strong></p>
<h3 id="探索「内部缓存」"><a href="#探索「内部缓存」" class="headerlink" title="探索「内部缓存」"></a>探索「内部缓存」</h3><p>先说结论：</p>
<p><strong>「内部缓存」由所有已安装应用的 /data/data/packagename/cache 文件夹组成。</strong></p>
<p>从上面的 <code>handleStartCopy</code> 方法中可知 Internal 的 <code>cacheSize</code> 部分在 <code>getPackageSizeInfoLI</code> 方法里，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">getPackageSizeInfoLI</span><span class="params">(String packageName, PackageStats pStats)</span> {</span><br><span class="line">    ......</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> mInstaller.getSizeInfo(packageName, p.mPath, publicSrcDir,</span><br><span class="line">                asecPath, pStats);</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个方法定义在文件 frameworks/base/services/java/com/android/server/pm/PackageManagerService.java 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Installer</span> {</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">connect</span><span class="params">()</span> {</span><br><span class="line">            ......</span><br><span class="line">            <span class="type">LocalSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalSocketAddress</span>(<span class="string">"installd"</span>,</span><br><span class="line">                    LocalSocketAddress.Namespace.RESERVED);</span><br><span class="line"></span><br><span class="line">            mSocket.connect(address);</span><br><span class="line">            ......</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> String <span class="title function_">transaction</span><span class="params">(String cmd)</span> {</span><br><span class="line">        <span class="keyword">if</span> (!connect()) {</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!writeCommand(cmd)) {</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (readReply()) {</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSizeInfo</span><span class="params">(String pkgName, String apkPath, String fwdLockApkPath,</span></span><br><span class="line"><span class="params">            String asecPath, PackageStats pStats)</span> {</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">"getsize"</span>);</span><br><span class="line">        builder.append(<span class="string">' '</span>);</span><br><span class="line">        builder.append(pkgName);</span><br><span class="line">        builder.append(<span class="string">' '</span>);</span><br><span class="line">        builder.append(apkPath);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> transaction(builder.toString());</span><br><span class="line">        String res[] = s.split(<span class="string">" "</span>);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            ......</span><br><span class="line">            pStats.cacheSize = Long.parseLong(res[<span class="number">3</span>]);</span><br><span class="line">            ......</span><br><span class="line">        } <span class="keyword">catch</span> (NumberFormatException e) {</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个方法定义在文件 frameworks/base/services/java/com/android/server/pm/Installer.java 中。</p>
<p><code>getSizeInfo</code> 方法最终是通过给 /dev/socket/installd 发送 <code>getsize packagename apkpath ...</code> 获取的输出中解析出来。</p>
<p>/dev/socket/installd 的源码在 frameworks/base/cmds/installd，<code>getsize</code> 命令最后在 <code>get_size</code> 函数中处理，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">get_size</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pkgname, <span class="type">const</span> <span class="type">char</span> *apkpath,</span></span><br><span class="line"><span class="params">             <span class="type">const</span> <span class="type">char</span> *fwdlock_apkpath, <span class="type">const</span> <span class="type">char</span> *asecpath,</span></span><br><span class="line"><span class="params">             <span class="type">int64_t</span> *_codesize, <span class="type">int64_t</span> *_datasize, <span class="type">int64_t</span> *_cachesize,</span></span><br><span class="line"><span class="params">             <span class="type">int64_t</span>* _asecsize)</span></span><br><span class="line">{</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (create_pkg_path(path, pkgname, PKG_DIR_POSTFIX, <span class="number">0</span>)) {</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    d = opendir(path);</span><br><span class="line">    ......</span><br><span class="line">    dfd = dirfd(d);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">while</span> ((de = readdir(d))) {</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *name = de-&gt;d_name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (de-&gt;d_type == DT_DIR) {</span><br><span class="line">            ......</span><br><span class="line">            subfd = openat(dfd, name, O_RDONLY | O_DIRECTORY);</span><br><span class="line">            <span class="keyword">if</span> (subfd &gt;= <span class="number">0</span>) {</span><br><span class="line">                <span class="type">int64_t</span> size = calculate_dir_size(subfd);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name,<span class="string">"lib"</span>)) {</span><br><span class="line">                    codesize += size;</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(name,<span class="string">"cache"</span>)) {</span><br><span class="line">                    cachesize += size;</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    datasize += size;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ......</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个函数定义在文件 frameworks/base/cmds/installd/Commands.c 中。</p>
<p>我们来看一下 <code>path</code> 是什么值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">create_pkg_path</span><span class="params">(<span class="type">char</span> path[PKG_PATH_MAX],</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> <span class="type">char</span> *pkgname,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> <span class="type">char</span> *postfix,</span></span><br><span class="line"><span class="params">                    <span class="type">uid_t</span> persona)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">size_t</span> uid_len;</span><br><span class="line">    <span class="type">char</span>* persona_prefix;</span><br><span class="line">    <span class="keyword">if</span> (persona == <span class="number">0</span>) {</span><br><span class="line">        persona_prefix = PRIMARY_USER_PREFIX;</span><br><span class="line">        uid_len = <span class="number">0</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> prefix_len = android_data_dir.len + <span class="built_in">strlen</span>(persona_prefix) + uid_len + <span class="number">1</span> <span class="comment">/*slash*/</span>;</span><br><span class="line">    <span class="type">char</span> prefix[prefix_len + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *dst = prefix;</span><br><span class="line">    <span class="type">size_t</span> dst_size = <span class="keyword">sizeof</span>(prefix);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (append_and_increment(&amp;dst, android_data_dir.path, &amp;dst_size) &lt; <span class="number">0</span></span><br><span class="line">            || append_and_increment(&amp;dst, persona_prefix, &amp;dst_size) &lt; <span class="number">0</span>) {</span><br><span class="line">        ALOGE(<span class="string">"Error building prefix for APK path"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="type">dir_rec_t</span> dir;</span><br><span class="line">    dir.path = prefix;</span><br><span class="line">    dir.len = prefix_len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> create_pkg_path_in_dir(path, &amp;dir, pkgname, postfix);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个函数定义在文件 frameworks/base/cmds/installd/utils.c 中。</p>
<p>可见 <code>path</code> 就是由 <code>android_data_dir.path</code>，<code>PRIMARY_USER_PREFIX</code>，<code>pkgname</code> 和 <code>PKG_DIR_POSTFIX</code> 四段拼接起来的，<code>pkgname</code> 就是包名，其它几个值分别是什么呢？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_USER_PREFIX    <span class="string">"data/"</span></span></span><br><span class="line">......</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PKG_DIR_POSTFIX        <span class="string">""</span></span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>这些宏定义在 frameworks/base/cmds/installd/installd.h 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">initialize_globals</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// Get the android data directory.</span></span><br><span class="line">    <span class="keyword">if</span> (get_path_from_env(&amp;android_data_dir, <span class="string">"ANDROID_DATA"</span>) &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个函数定义在文件 frameworks/base/cmds/installd/installd.c 中。</p>
<p><code>android_data_dir</code> 其实是获取的系统的 <code>ANDROID_DATA</code> 环境变量值，就是 <code>/data</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell@aries:/ $ echo $ANDROID_DATA</span><br><span class="line">/data</span><br></pre></td></tr></table></figure>

<p>所以 <code>path</code> 的值即为 <code>/data/data/pkgname</code>，而 <code>cacheSize</code> 即为它下面的 <code>cache</code> 文件夹的大小。</p>
<p>即有小结论二：</p>
<p><strong>「内部缓存」由所有已安装应用的 /data/data/packagename/cache 文件夹组成。</strong></p>
<p>以上，我们的结论得证。</p>
<h2 id="系统缓存大小的计算"><a href="#系统缓存大小的计算" class="headerlink" title="系统缓存大小的计算"></a>系统缓存大小的计算</h2><p>通过上一节我们已经知道了「系统缓存」的文件构成，在想要计算系统缓存大小的时候下意识的想法就是，用代码计算一下这两个文件夹的大小不就行了？</p>
<p>事实证明这个想法只是 too young, sometimes naive.</p>
<p>/data/data/packagename/cache 文件夹每个应用访问属于自己的无压力，但其它应用是没有权限读取的，如果是做本应用内的缓存清理，那事情就简单了，直接算一算就好了。</p>
<p>如果是要做针对所有应用的缓存清理功能，那就得另想办法了。</p>
<p>这里分了两种情况：能获取 root 权限和不能获取 root 权限。我们这里先讨论非 root 权限的系统缓存计算和清理，root 权限的情况在后文会有说明。</p>
<p>既然直接计算文件夹大小的方法行不通了，那就仍然重复上面的故事，参考 Settings APP 的做法吧。</p>
<h3 id="Settings-计算缓存大小的方法"><a href="#Settings-计算缓存大小的方法" class="headerlink" title="Settings 计算缓存大小的方法"></a>Settings 计算缓存大小的方法</h3><p>Settings APP 使用了 <code>PackageManager.getPackageSizeInfo</code> 方法来做此事，难道 so easy？屁颠屁颠去查了一下 Android API，发现 <code>PacakgeManager</code> 的文档中压根就没有出现 <code>getPackageSizeInfo</code> 的身影，好吧这是一个不对外公开的 API。</p>
<p>但是区区困难怎么拦得住一颗改变世界的心？对付隐藏 API 我们还有反射大法。</p>
<p>我们回顾一下 Settings APP 里的做法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BackgroundHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> {</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> IPackageStatsObserver.<span class="type">Stub</span> <span class="variable">mStatsObserver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IPackageStatsObserver</span>.Stub() {</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGetStatsCompleted</span><span class="params">(PackageStats stats, <span class="type">boolean</span> succeeded)</span> {</span><br><span class="line">                    ......</span><br><span class="line">                                    entry.cacheSize = stats.cacheSize;</span><br><span class="line">                                    ......</span><br><span class="line">                                    entry.externalCacheSize = stats.externalCacheSize;</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">    ......</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> {</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) {</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">case</span> MSG_LOAD_SIZES: {</span><br><span class="line">                <span class="keyword">synchronized</span> (mEntriesMap) {</span><br><span class="line">                    ......</span><br><span class="line">                                mPm.getPackageSizeInfo(mCurComputingSizePkg, mStatsObserver);</span><br><span class="line">                    ......</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个类定义在文件 packages/apps/Settings/src/com/android/settings/applications/ApplicationsState.java 中。</p>
<p>这里有两个问题需要解决：</p>
<ol>
<li><p><code>getPackageSizeInfo</code> 方法是一个 <code>@hide</code> 方法，需要通过反射来调用。</p>
<p>从 PackageManager.java 文件的 <code>getPackageSizeInfo</code> 方法定义处可知，它需要 <code>GET_PACKAGE_SIZE</code> 权限，幸运的是，从 frameworks/base/core/res/AndroidManifex.xml 文件里可知，该权限的 Protection level 为 normal，是可以正常声明的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Allows an application to find out the space used by any package. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.GET_PACKAGE_SIZE"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:permissionGroup</span>=<span class="string">"android.permission-group.SYSTEM_TOOLS"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"normal"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/permlab_getPackageSize"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/permdesc_getPackageSize"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段代码定义在文件 frameworks/base/core/res/AndroidManifex.xml 中。</p>
</li>
<li><p>传给 <code>getPackageSizeInfo</code> 方法的第二个参数类型 <code>IPackageStatsObserver</code> 是在 android.content.pm 包下，需要自已通过 aidl 方式定义。</p>
</li>
</ol>
<h3 id="计算缓存大小的实现"><a href="#计算缓存大小的实现" class="headerlink" title="计算缓存大小的实现"></a>计算缓存大小的实现</h3><p>解决步骤：</p>
<ol>
<li><p>在自己的工程的 src/main 目录下创建包目录结构 aidl/android/content/pm。</p>
<p><em>注：这是使用 Android Studio 的默认做法，使用 Eclipse 默认在 src 目录下创建包目录结构 android/content/pm。</em></p>
</li>
<li><p>将 Android 源码 frameworks/base/core/java/android/content/pm 目录下的 IPackageStatsObserver.aidl 与其依赖的 PackageStats.aidl 拷贝到上面一步创建的目录里。</p>
</li>
<li><p>根据 frameworks/base/core/java/android/content/pm/PackageManager.java 的 <code>getPackageSizeInfo</code> 接口上面的注释可知，需要在 AndroidManifest.xml 里声明需要 <code>GET_PACKAGE_SIZE</code> 权限。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.GET_PACKAGE_SIZE"</span>&gt;</span><span class="tag">&lt;/<span class="name">uses-permission</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取 QQ 的系统缓存大小的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">someFunc</span><span class="params">()</span> {</span><br><span class="line">    IPackageStatsObserver.<span class="type">Stub</span> <span class="variable">observer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageSizeObserver</span>();</span><br><span class="line">    getPackageInfo(<span class="string">"com.tencent.mobileqq"</span>, observer);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPackageInfo</span><span class="params">(String packageName, IPackageStatsObserver.Stub observer)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> ContextUtil.applicationContext.getPackageManager();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getPackageSizeInfo</span> <span class="operator">=</span> pm.getClass()</span><br><span class="line">                .getMethod(<span class="string">"getPackageSizeInfo"</span>, String.class, IPackageStatsObserver.class);</span><br><span class="line"></span><br><span class="line">        getPackageSizeInfo.invoke(pm, packageName, observer);</span><br><span class="line">    } <span class="keyword">catch</span> (NoSuchMethodException e ) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">catch</span> (IllegalAccessException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">catch</span> (InvocationTargetException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PackageSizeObserver</span> <span class="keyword">extends</span> <span class="title class_">IPackageStatsObserver</span>.Stub {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGetStatsCompleted</span><span class="params">(PackageStats packageStats, <span class="type">boolean</span> succeeded)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException {</span><br><span class="line">        <span class="keyword">if</span> (packageStats == <span class="literal">null</span> || !succeeded) {</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="type">AppEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AppEntry</span>();</span><br><span class="line">            entry.packageName = packageStats.packagename;</span><br><span class="line">            entry.cacheSize = packageStats.cacheSize + packageStats.externalCacheSize;</span><br><span class="line">            <span class="comment">// do something else，比如把 entry 通过消息发送给需要的地方，或者添加到你的列表里</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取一个应用的缓存的问题解决了，获取所有应用的系统缓存也就是遍历系统已安装应用，然后挨个调用 <code>getPackageInfo</code> 的事儿了。</p>
</li>
</ol>
<p>完整的实例见 <a class="link" target="_blank" rel="noopener" href="https://github.com/mzlogin/CleanExpert">https://github.com/mzlogin/CleanExpert<i class="fas fa-external-link-alt"></i></a>。</p>
<h2 id="系统缓存的清理"><a href="#系统缓存的清理" class="headerlink" title="系统缓存的清理"></a>系统缓存的清理</h2><p>既然借鉴 Settings APP 的做法如此好使，在做缓存清理时我们当然故伎重施。我们先来看看它是怎样清理某一个应用的缓存的。</p>
<h3 id="Settings-清理缓存的方法"><a href="#Settings-清理缓存的方法" class="headerlink" title="Settings 清理缓存的方法"></a>Settings 清理缓存的方法</h3><p>在 InstalledAppDetails.java 里能根据名称找到对应「清除缓存」按钮相关的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstalledAppDetails</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener, CompoundButton.OnCheckedChangeListener,</span><br><span class="line">        ApplicationsState.Callbacks {</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">private</span> Button mClearCacheButton;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ClearCacheObserver</span> <span class="keyword">extends</span> <span class="title class_">IPackageDataObserver</span>.Stub {</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRemoveCompleted</span><span class="params">(<span class="keyword">final</span> String packageName, <span class="keyword">final</span> <span class="type">boolean</span> succeeded)</span> {</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(CLEAR_CACHE);</span><br><span class="line">            msg.arg1 = succeeded ? OP_SUCCESSFUL:OP_FAILED;</span><br><span class="line">            mHandler.sendMessage(msg);</span><br><span class="line">         }</span><br><span class="line">     }</span><br><span class="line">    ......</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> {</span><br><span class="line">        ......</span><br><span class="line">        mClearCacheButton = (Button) view.findViewById(R.id.clear_cache_button);</span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshSizeInfo</span><span class="params">()</span> {</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (cacheSize &lt;= <span class="number">0</span>) {</span><br><span class="line">            mClearCacheButton.setEnabled(<span class="literal">false</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            mClearCacheButton.setEnabled(<span class="literal">true</span>);</span><br><span class="line">            mClearCacheButton.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> {</span><br><span class="line">        ......</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (v == mClearCacheButton) {</span><br><span class="line">            <span class="comment">// Lazy initialization of observer</span></span><br><span class="line">            <span class="keyword">if</span> (mClearCacheObserver == <span class="literal">null</span>) {</span><br><span class="line">                mClearCacheObserver = <span class="keyword">new</span> <span class="title class_">ClearCacheObserver</span>();</span><br><span class="line">            }</span><br><span class="line">            mPm.deleteApplicationCacheFiles(packageName, mClearCacheObserver);</span><br><span class="line">        }</span><br><span class="line">        ......</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>这个类定义在文件 packages/apps/Settings/src/com/android/settings/applications/InstalledAppDetails.java 中。</p>
<p>是不是很熟悉？是不是很激动？是不是觉得顶多再次祭出反射大法就能继续拯救世界了？先冷静一下，看看 frameworks/base/core/java/android/content/pm/PackageManager.java 文件里 <code>deleteApplicationCacheFiles</code> 方法上面的注释。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Attempts to delete the cache files associated with an application.</span></span><br><span class="line"><span class="comment"> * Since this may take a little while, the result will</span></span><br><span class="line"><span class="comment"> * be posted back to the given observer.  A deletion will fail if the calling context</span></span><br><span class="line"><span class="comment"> * lacks the {<span class="doctag">@link</span> android.Manifest.permission#DELETE_CACHE_FILES} permission, if the</span></span><br><span class="line"><span class="comment"> * named package cannot be found, or if the named package is a "system package".</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ......</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>没错它又是一个 <code>@hide</code> 方法，关键是它需要 <code>DELETE_CACHE_FILES</code> 权限，而该权限的相关声明如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Allows an application to delete cache files. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.DELETE_CACHE_FILES"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/permlab_deleteCacheFiles"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/permdesc_deleteCacheFiles"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"signature|system"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段声明定义在 frameworks/base/core/res/AndroidManifest.xml 中。</p>
<p>它的 protectionLevel 为 <code>signature|system</code>，系统应用或者与系统采用相同签名的应用才能获得此权限。</p>
<p>此路不通。</p>
<h3 id="新的发现"><a href="#新的发现" class="headerlink" title="新的发现"></a>新的发现</h3><p>那就继续想其它办法了。frameworks/base/core/java/android/content/pm/PackageManager.java 里提供了很多实用的功能，比如上面的系统缓存的大小计算以及清理都是它里面声明的方法，仔细看一下它里面声明的其它方法还真是有发现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Free storage by deleting LRU sorted list of cache files across</span></span><br><span class="line"><span class="comment"> * all applications. If the currently available free storage</span></span><br><span class="line"><span class="comment"> * on the device is greater than or equal to the requested</span></span><br><span class="line"><span class="comment"> * free storage, no cache files are cleared. If the currently</span></span><br><span class="line"><span class="comment"> * available storage on the device is less than the requested</span></span><br><span class="line"><span class="comment"> * free storage, some or all of the cache files across</span></span><br><span class="line"><span class="comment"> * all applications are deleted (based on last accessed time)</span></span><br><span class="line"><span class="comment"> * to increase the free storage space on the device to</span></span><br><span class="line"><span class="comment"> * the requested value. There is no guarantee that clearing all</span></span><br><span class="line"><span class="comment"> * the cache files from all applications will clear up</span></span><br><span class="line"><span class="comment"> * enough storage to achieve the desired value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> freeStorageSize The number of bytes of storage to be</span></span><br><span class="line"><span class="comment"> * freed by the system. Say if freeStorageSize is XX,</span></span><br><span class="line"><span class="comment"> * and the current free storage is YY,</span></span><br><span class="line"><span class="comment"> * if XX is less than YY, just return. if not free XX-YY number</span></span><br><span class="line"><span class="comment"> * of bytes if possible.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> observer call back used to notify when</span></span><br><span class="line"><span class="comment"> * the operation is completed</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">freeStorageAndNotify</span><span class="params">(<span class="type">long</span> freeStorageSize, IPackageDataObserver observer)</span>;</span><br></pre></td></tr></table></figure>

<p>从解释来看它是用来在必要时释放所有应用的缓存所占空间的，在 Android 源码里搜索一下它被调用的地方，有一处是在 frameworks/base/services/java/com/android/server/DeviceStorageMonitorService.java 中，大致的逻辑是在系统空间不够的时候，提示用户清理系统缓存。</p>
<p>我们来看看这个方法实际做了什么事情：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PackageManagerService</span> <span class="keyword">extends</span> <span class="title class_">IPackageManager</span>.Stub {</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">freeStorageAndNotify</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> freeStorageSize, <span class="keyword">final</span> IPackageDataObserver observer)</span> {</span><br><span class="line">        mContext.enforceCallingOrSelfPermission(</span><br><span class="line">                android.Manifest.permission.CLEAR_APP_CACHE, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// Queue up an async operation since clearing cache may take a little while.</span></span><br><span class="line">        mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                mHandler.removeCallbacks(<span class="built_in">this</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">retCode</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                retCode = mInstaller.freeCache(freeStorageSize);</span><br><span class="line">                <span class="keyword">if</span> (retCode &lt; <span class="number">0</span>) {</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Couldn't clear application caches"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="literal">null</span>) {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        observer.onRemoveCompleted(<span class="literal">null</span>, (retCode &gt;= <span class="number">0</span>));</span><br><span class="line">                    } <span class="keyword">catch</span> (RemoteException e) {</span><br><span class="line">                        Slog.w(TAG, <span class="string">"RemoveException when invoking call back"</span>);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个类定义在文件 frameworks/base/services/java/com/android/server/pm/PackageManagerService.java 中。</p>
<p>也就是说，这个方法的注释里没有提及它需要申请什么权限，但事实上它是需要 <code>CLEAR_APP_CACHE</code> 权限的。</p>
<p>该权限的相关声明：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Allows an application to clear the caches of all installed</span></span><br><span class="line"><span class="comment">     applications on the device.  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.CLEAR_APP_CACHE"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:permissionGroup</span>=<span class="string">"android.permission-group.SYSTEM_TOOLS"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"dangerous"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/permlab_clearAppCache"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/permdesc_clearAppCache"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段声明定义在 frameworks/base/core/res/AndroidManifest.xml 中。</p>
<p>虽然它的 protectionLevel 是 <code>dangerous</code>，但是好歹还是能用的。</p>
<p>另外，跟踪实际执行清理过程的 <code>retCode = mInstaller.freeCache(freeStorageSize);</code> 这一行实际是通过给 /dev/socket/installd 发送 <code>freecache freeStorageSize</code> 来完成清理过程，最终调用到如下函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">free_cache</span><span class="params">(<span class="type">int64_t</span> free_size)</span></span><br><span class="line">{</span><br><span class="line">    ......</span><br><span class="line">    <span class="type">char</span> datadir[PKG_PATH_MAX];</span><br><span class="line">    avail = disk_free();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (avail &gt;= free_size) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (create_persona_path(datadir, <span class="number">0</span>)) { <span class="comment">// /data/data</span></span><br><span class="line">        ......</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    d = opendir(datadir);</span><br><span class="line">    ......</span><br><span class="line">    dfd = dirfd(d);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((de = readdir(d))) {</span><br><span class="line">        <span class="keyword">if</span> (de-&gt;d_type != DT_DIR) <span class="keyword">continue</span>;</span><br><span class="line">        name = de-&gt;d_name;</span><br><span class="line">        ......</span><br><span class="line">        subfd = openat(dfd, name, O_RDONLY | O_DIRECTORY);</span><br><span class="line">        <span class="keyword">if</span> (subfd &lt; <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        delete_dir_contents_fd(subfd, <span class="string">"cache"</span>);</span><br><span class="line">        close(subfd);</span><br><span class="line"></span><br><span class="line">        avail = disk_free();</span><br><span class="line">        <span class="keyword">if</span> (avail &gt;= free_size) {</span><br><span class="line">            closedir(d);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ......</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>这个函数定义在文件 frameworks/base/cmds/installd/Commands.c 中。</p>
<p>实际就是遍历 /data/data 下的所有文件夹，依次删除它们下面的 cache 子目录，直到磁盘的可用空间大于需要的空间为止。</p>
<p><strong>也就是说，<code>freeStorageAndNotify</code> 只是删除了「内部缓存」，扩展存储上的「外部缓存」需要我们另外处理。</strong></p>
<h3 id="清理缓存的实现"><a href="#清理缓存的实现" class="headerlink" title="清理缓存的实现"></a>清理缓存的实现</h3><p>参考 frameworks/base/services/java/com/android/server/DeviceStorageMonitorService.java 中对 <code>freeStorageAndNotify</code> 的相关调用，最后我们的实现步骤如下：</p>
<ol>
<li><p>在自己的工程的 src/main 目录下创建包目录结构 aidl/android/content/pm。</p>
<p><em>注：这是使用 Android Studio 的默认做法，使用 Eclipse 默认在 src 目录下创建包目录结构 android/content/pm。</em></p>
</li>
<li><p>将 Android 源码 frameworks/base/core/java/android/content/pm 目录下的 IPackageDataObserver.aidl 拷贝到上面一步创建的目录里。</p>
</li>
<li><p>在 AndroidManifest.xml 里声明 <code>CLEAR_APP_CACHE</code> 权限。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.CLEAR_APP_CACHE"</span>&gt;</span><span class="tag">&lt;/<span class="name">uses-permission</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过反射调用 <code>freeStorageAndNotify</code> 方法，第一个参数给它一个足够大的值，它就会帮我们清理掉所有应用的缓存了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">freeAllAppsCache</span><span class="params">(<span class="keyword">final</span> Handler handler)</span> {</span><br><span class="line"></span><br><span class="line">    <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> ContextUtil.applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="type">File</span> <span class="variable">externalDir</span> <span class="operator">=</span> context.getExternalCacheDir();</span><br><span class="line">    <span class="keyword">if</span> (externalDir == <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> context.getPackageManager();</span><br><span class="line">    List&lt;ApplicationInfo&gt; installedPackages = pm.getInstalledApplications(PackageManager.GET_GIDS);</span><br><span class="line">    <span class="keyword">for</span> (ApplicationInfo info : installedPackages) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">externalCacheDir</span> <span class="operator">=</span> externalDir.getAbsolutePath()</span><br><span class="line">                .replace(context.getPackageName(), info.packageName);</span><br><span class="line">        <span class="type">File</span> <span class="variable">externalCache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(externalCacheDir);</span><br><span class="line">        <span class="keyword">if</span> (externalCache.exists() &amp;&amp; externalCache.isDirectory()) {</span><br><span class="line">            deleteFile(externalCache);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">Method</span> <span class="variable">freeStorageAndNotify</span> <span class="operator">=</span> pm.getClass()</span><br><span class="line">                .getMethod(<span class="string">"freeStorageAndNotify"</span>, <span class="type">long</span>.class, IPackageDataObserver.class);</span><br><span class="line">        <span class="type">long</span> <span class="variable">freeStorageSize</span> <span class="operator">=</span> Long.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">        freeStorageAndNotify.invoke(pm, freeStorageSize, <span class="keyword">new</span> <span class="title class_">IPackageDataObserver</span>.Stub() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRemoveCompleted</span><span class="params">(String packageName, <span class="type">boolean</span> succeeded)</span> <span class="keyword">throws</span> RemoteException {</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> handler.obtainMessage(JunkCleanActivity.MSG_SYS_CACHE_CLEAN_FINISH);</span><br><span class="line">                msg.sendToTarget();</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">catch</span> (IllegalAccessException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">catch</span> (InvocationTargetException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">deleteFile</span><span class="params">(File file)</span> {</span><br><span class="line">    <span class="keyword">if</span> (file.isDirectory()) {</span><br><span class="line">        String[] children = file.list();</span><br><span class="line">        <span class="keyword">for</span> (String name : children) {</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">suc</span> <span class="operator">=</span> deleteFile(<span class="keyword">new</span> <span class="title class_">File</span>(file, name));</span><br><span class="line">            <span class="keyword">if</span> (!suc) {</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> file.delete();</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li>
</ol>
<p>完整的实例见 <a class="link" target="_blank" rel="noopener" href="https://github.com/mzlogin/CleanExpert">https://github.com/mzlogin/CleanExpert<i class="fas fa-external-link-alt"></i></a>。</p>
<p><strong>备注：</strong>经测试该方法在 Android 6.0 版本和部分 5.0+ 版本上已经失效，Android 源码里已经给 <code>freeStorageAndNotify</code> 方法声明添加了 <code>@SystemApi</code> 注释（开始添加了 <code>@PrivateApi</code>，后修改为 <code>@SystemApi</code>），见「<a class="link" target="_blank" rel="noopener" href="https://github.com/android/platform_frameworks_base/commit/8b0cfb7dbde6f19a5dd5879fef3d16576f2eeba4#diff-a5f0b5ebe6a871aca1c5841bc0497538R3225">添加<i class="fas fa-external-link-alt"></i></a>」和「<a class="link" target="_blank" rel="noopener" href="https://github.com/android/platform_frameworks_base/commit/d5a5b5a547462f3e7c6315a501909bce2418ba86#diff-a5f0b5ebe6a871aca1c5841bc0497538R3233">修改<i class="fas fa-external-link-alt"></i></a>」两次提交，而且 <code>CLEAR_APP_CACHE</code> 方法的权限已经由 <code>dangerous</code> 改成了 <code>system|signature</code>，已经无法通过反射来正常调用，会产生 <code>java.lang.reflect.InvocationTargetException</code>，所以在这些版本上需要另想办法了，StackOverflow 上的一个相关讨论链接：<a class="link" target="_blank" rel="noopener" href="http://stackoverflow.com/questions/26752656/whats-the-meaning-of-new-systemapi-annotation-any-difference-from-hide/27321030#27321030">What’s the meaning of new @SystemApi annotation, any difference from @hide?<i class="fas fa-external-link-alt"></i></a>。</p>
<h2 id="有-root-权限的系统缓存计算与清理"><a href="#有-root-权限的系统缓存计算与清理" class="headerlink" title="有 root 权限的系统缓存计算与清理"></a>有 root 权限的系统缓存计算与清理</h2><p>如果能获取到 root 权限，/data/data 目录的访问限制也就不再是问题，计算缓存大小和清理缓存也就不用再受上面说的方法与权限的限制了，而且能做一些没有 root 权限的情况下做不到的事情，比如：</p>
<ol>
<li><p>清理单个应用的缓存。</p>
</li>
<li><p>列出应用的缓存文件列表供用户选择性清理。</p>
</li>
</ol>
<p>实现思路很简单粗暴（如下思路未写实例验证）：</p>
<p><strong>思路一</strong> 通过 <code>su</code> 命令获取一个有 root 权限的 shell，然后通过与它交互来获取缓存文件夹的大小或清理缓存，比如让它执行命令 <code>du -h /data/data/com.trello/cache</code> 就能获取到 trello 的「内部缓存」大小，让它执行 <code>rm -rf /data/data/com.trello/cache</code> 就能删除 trello 的「内部缓存」。</p>
<p><em>注：<code>du</code> 命令行与参数在不同 ROM 下的不一致，所以并不推荐此做法。</em></p>
<p><strong>思路二</strong> 或者，也可以做一个原生程序专门来负责缓存计算与清理，通过 <code>su</code> 命令获取有 root 权限的 shell，再用 shell 创建该原生程序进程，它继承 shell 的 root 权限，然后它就可以计算缓存大小与清理缓存，再将结果上报给 APP 进程。</p>

            </div>

            
                <div class="post-copyright-info">
                    
<div class="article-copyright-info-container">
    <ul class="copyright-info-content">
        <li class="post-title">
            <span class="type">本文标题</span>：<span class="content">Android 系统缓存扫描与清理方法分析</span>
        </li>
        <li class="post-author">
            <span class="type">本文作者</span>：<span class="content">Pin Young</span>
        </li>
        <li class="post-time">
            <span class="type">创建时间</span>：<span class="content">2021-03-28 00:00:00</span>
        </li>
        <li class="post-link">
            <span class="type">本文链接</span>：<span class="content">posts/bb90.html</span>
        </li>
        <li class="post-license">
            <span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span>
        </li>
    </ul>
    <div class="copy-copyright-info flex-center tooltip" data-content="复制版权信息" data-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                </div>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev" rel="prev" href="/posts/3c46.html">
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">为 Markdown 生成 TOC 的 Vim 插件</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next" rel="next" href="/posts/94f6.html">
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Ubuntu 使用笔记</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-number">1.</span> <span class="nav-text">系统缓存的定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%BC%93%E5%AD%98%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-number">2.</span> <span class="nav-text">系统缓存的组成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A2%E7%B4%A2%E3%80%8C%E5%A4%96%E9%83%A8%E7%BC%93%E5%AD%98%E3%80%8D"><span class="nav-number">2.1.</span> <span class="nav-text">探索「外部缓存」</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A2%E7%B4%A2%E3%80%8C%E5%86%85%E9%83%A8%E7%BC%93%E5%AD%98%E3%80%8D"><span class="nav-number">2.2.</span> <span class="nav-text">探索「内部缓存」</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%BC%93%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%9A%84%E8%AE%A1%E7%AE%97"><span class="nav-number">3.</span> <span class="nav-text">系统缓存大小的计算</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Settings-%E8%AE%A1%E7%AE%97%E7%BC%93%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">3.1.</span> <span class="nav-text">Settings 计算缓存大小的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E7%BC%93%E5%AD%98%E5%A4%A7%E5%B0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.2.</span> <span class="nav-text">计算缓存大小的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%BC%93%E5%AD%98%E7%9A%84%E6%B8%85%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">系统缓存的清理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Settings-%E6%B8%85%E7%90%86%E7%BC%93%E5%AD%98%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">4.1.</span> <span class="nav-text">Settings 清理缓存的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E7%9A%84%E5%8F%91%E7%8E%B0"><span class="nav-number">4.2.</span> <span class="nav-text">新的发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%85%E7%90%86%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.3.</span> <span class="nav-text">清理缓存的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%89-root-%E6%9D%83%E9%99%90%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%BC%93%E5%AD%98%E8%AE%A1%E7%AE%97%E4%B8%8E%E6%B8%85%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">有 root 权限的系统缓存计算与清理</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            ©
            
                <span>2014</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">Pin Young</a>
            
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    访问人数&nbsp;<span id="busuanzi_value_site_uv"></span> 
                
                
                    总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/dstansice">零域Lite 1.3.1</a>
        </div>
        
        
        <script async defer data-website-id="b3b1feba-ef0f-4367-ba34-6a0152b8749b" src="https://analysis.0skyu.cn/umami.js"></script>
         
            <div class="icp-info info-item">
            <div class="theme-info info-item">
                <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12011002021027" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="https://0skyu.cn/beian.png" style="float:left;"><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">津公网安备 12011002021027号</p></a> 
                </div>
                 <div class="theme-info info-item">
               <center> <a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">
                    津ICP备2021004482号-1
                </a></center>
                </div>
                
            </div>
        
        
            <div class="deploy-info info-item">
                
                    <a target="_blank" rel="nofollow" href="https://hao.0skyu.cn/">
                
                    本站由 <span class="tooltip" data-content="腾讯云"><img src="/images/deploy-provider/tencent_cloud.png?v=9693e72d12"></span> 提供部署服务
                
                    </a>
                
            </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center" href="/atom.xml" target="_blank">
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js?v=cbd27e8569"></script>

<script src="/js/main.js?v=3ab50fd2bb"></script>

<script src="/js/header-shrink.js?v=0418df63d7"></script>

<script src="/js/back2top.js?v=139ceb0539"></script>

<script src="/js/dark-light-toggle.js?v=f21816b072"></script>





    
<script src="/js/local-search.js?v=0ce0b1d637"></script>




    
<script src="/js/code-block.js?v=63706df46d"></script>




    
<script src="/js/lazyload.js?v=f1e4b68ec3"></script>



<div class="post-scripts pjax">
    
        
<script src="/js/post-helper.js?v=34bd3800c9"></script>

        
            
<script src="/js/libs/anime.min.js?v=864a144dbb"></script>

        
        
            
<script src="/js/toc.js?v=037238356c"></script>

        
    
</div>


    
<script src="/js/libs/pjax.min.js?v=cdf1c08dca"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>

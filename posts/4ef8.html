<!DOCTYPE html><html lang="zh-CN"><head><link rel="stylesheet" href="/css/bilicard.css"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="空中有零，零域，分享快乐，音乐，心得，生活，电影，代码，编程，考试，学业，零式的天空，凌空博客，原零空博客，原Tans博客，现零的小屋官方博客，计算机，音乐，电脑，编程，生活，分享"><meta name="description" content="一个技术控，爱技术，爱分享，爱音乐"><meta name="author" content="Pin Young"><script defer data-pjax src="/js/iosurl.js"></script><title>Unix-Linux编程实践教程-chapter11-socket | 零域</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/img/favicon.png"><link rel="stylesheet" href="/font/css/fontawesome.min.css"><link rel="stylesheet" href="/font/css/regular.min.css"><link rel="stylesheet" href="/font/css/solid.min.css"><link rel="stylesheet" href="/font/css/brands.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"0skyu.cn",root:"/",language:"zh-CN",path:"search.xml"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!0,init_open:!0},style:{primary_color:"#EE5A24",logo:"/img/favicon.png",favicon:"/img/favicon.png",avatar:"img/1.jpg",font_size:null,font_family:null,hover:{shadow:!0,scale:!1},first_screen:{enable:!0,header_transparent:!1,background_img:"/img/bg/333.jpg",description:"Keep writing and Keep loving.",font_color:"#f0d21a",hitokoto:!0},scroll:{progress_bar:!0,percent:!1}},local_search:{enable:!0,preload:!0},code_copy:{},code_block:{tools:{enable:!0,style:"default"},highlight_theme:"default"},side_tools:{},pjax:{enable:!0},lazyload:{enable:!0},comment:{enable:!1,use:"gitalk",valine:{appid:null,appkey:null,server_urls:null,placeholder:null},gitalk:{github_id:"DsTansice",github_admins:"DsTansice",repository:"Null-Comment",client_id:"b109b534b2268088d780",client_secret:"7808e138a1ffbcd9f02bb39cc1ee7fb41828c52f",proxy:null},twikoo:{env_id:"twikoo-0skyucn-1gkzaji32bb03146",region:null,version:"1.6.8"},waline:{server_url:null,reaction:!1,version:2}},post:{author_label:{enable:!0,auto:!0,custom_label_list:["Trainee","Engineer","Architect"]},word_count:{enable:!0,wordcount:!0,min2read:!0},img_align:"left",copyright_info:!0},version:"3.6.1"},KEEP.language_ago={second:"%s 秒前",minute:"%s 分钟前",hour:"%s 小时前",day:"%s 天前",week:"%s 周前",month:"%s 个月前",year:"%s 年前"},KEEP.language_code_block={copy:"复制代码",copied:"已复制",fold:"折叠代码块",folded:"已折叠"},KEEP.language_copy_copyright={copy:"复制版权信息",copied:"已复制",title:"原文标题",author:"原文作者",link:"原文链接"}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="零域" type="application/atom+xml">
</head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/img/favicon.png"> </a><a class="logo-title" href="/">零域</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">首页</a></li><li class="menu-item"><a href="/archives">归档</a></li><li class="menu-item"><a href="/tags">标签</a></li><li class="menu-item"><a href="/categories">分类</a></li><li class="menu-item"><a href="/links">友链</a></li><li class="menu-item"><a target="_blank" rel="noopener" href="https://hao.0skyu.cn/">HAO</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">首页</a></li><li class="drawer-menu-item flex-center"><a href="/archives">归档</a></li><li class="drawer-menu-item flex-center"><a href="/tags">标签</a></li><li class="drawer-menu-item flex-center"><a href="/categories">分类</a></li><li class="drawer-menu-item flex-center"><a href="/links">友链</a></li><li class="drawer-menu-item flex-center"><a target="_blank" rel="noopener" href="https://hao.0skyu.cn/">HAO</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">Unix-Linux编程实践教程-chapter11-socket</span></div><div class="article-header"><div class="avatar"><img src="/img/1.jpg"></div><div class="info"><div class="author"><span class="name">Pin Young</span> <span class="author-label">Lv9</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2016-08-03 00:51:07</span> <span class="mobile">2016-08-03 00:51</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-02-05 21:25:09</span> </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/programming/">programming</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/C/">C</a>&nbsp;</li><li>| <a href="/tags/Linux/">Linux</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>2.4k 字</span> </span><span class="article-min2read article-meta-item"><i class="fas fa-clock"></i>&nbsp;<span>11 分钟</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><h2 id="第１１章-连接到近端或远端的进程：服务器与Socket-套接字"><a href="#第１１章-连接到近端或远端的进程：服务器与Socket-套接字" class="headerlink" title="第１１章　连接到近端或远端的进程：服务器与Socket(套接字)"></a>第１１章　连接到近端或远端的进程：服务器与Socket(套接字)</h2><p>一些程序被作为单独的进程建立起来来接受和发送数据．在客户&#x2F;服务器模型中，<br>服务器进程为客户进程提供处理或数据服务</p><p>客户&#x2F;服务器系统包含通信系统和协议．客户和服务器通过管道或socket进行通信．<br>协议是会话过程中一系列规则的集合</p><p>popen库函数可以将任何shell程序嵌入服务器程序并且让对服务器的访问就像访问<br>缓存文件一样</p><p>管道是一对相连接的文件描述符．socket是一个未连接的通信端点，也是一个潜在<br>的文件描述符．客户进程通过把自己的socket和服务器端的socket相连来创建一个<br>通信连接</p><p>sockets之间的连接可以扩展到另一台机器上．每个socket以机器地址和端口来标识</p><p>到管道和socket的连接使用文件描述符．文件描述符为程序提供了与文件，设备和<br>其他的进程通信的统一编程接口</p><p>Unix中的计算器:bc<br>bc在内部启动了dc计算器程序，并通过管道与其进行通信</p><p>从bc方法中得到的思想：<br>１　客户&#x2F;服务器模型<br>bc&#x2F;dc程序对是客户&#x2F;服务器模型程序设计的一个实例．bc通过用户界面，<br>并使用dc提供的服务．这里bc被称为dc的客户<br>２　双向通信<br>客户&#x2F;服务器模型不同于生产线的数据处理模型，他要求一个进程既跟另<br>一个进程的标准输入也要和他的标准输出进行通信<br>３　永久性服务<br>bc让单一的dc进程处于运行状态，也就是bc不断的与dc的同一个实例进行<br>通信，而shell对每一个命令都创建一个新的进程<br>bc&#x2F;dc对被称之为协同进程(coroutines)以用来区别于子程序(subroutines)<br>两个程序都持续运行，当其中的一个程序完成自己的工作后将把控制权传给<br>另一个程序</p><p>bc的流程：<br>１　创建两个管道<br>２ 创建一个进程来运行dc<br>３ 在新创建的进程中，重定向标准输入和标准输出到管道，然后运行exec dc<br>４ 在父进程中，读取并分析用户的输入，将命令传给dc,dc读取响应，并把<br>响应传给用户</p><p>如果知道文件名，可以用fopen打开设备文件<br>如果只知道文件描述符，可以用fdopen命令:W</p><p>fopen打开一个指向文件的带缓冲的连接<br>FILE * fp;<br>fp &#x3D; fopen(“file”, “r”);<br>c &#x3D; getc(fp);<br>fgets(buf, len, fp);<br>fscanf(fp, “%d%d%s”, &amp;x, &amp;y, &amp;z);<br>fclose(fp);</p><p>popen打开一个指向进程的带缓冲的连接<br>FILE * fp;<br>fp &#x3D; popen(“ls”, “r”);<br>fgets(buf, len, fp);<br>pclose(fp);</p><p>如果不关闭，进程会变成僵尸进程．pclose中调用了wait函数等待进程的结束</p><p>访问数据：文件，应用程序接口，服务器<br>文件<br>依赖于特定的文件格式和结构体中特定的成员名称<br>函数<br>就算底层存储结构改变，接口程序依然可用<br>进程<br>使用进程，也就是调用独立的程序来获取数据，而不是自己写的程序</p><p>管道使得进程对其他进程发送数据就像向文件发送数据一样容易，但是因为管道<br>在进程中被创建，通过fork来实现共享，所以管道只能连接位于同一台主机上的<br>进程，而要与远端进程连接，需要使用socket</p><p>客户和服务器<br>服务器是提供服务的程序，是一个进程，等待请求，处理请求，然后循环回去<br>等下一个请求．客户端进程只要建立连接，与服务器交换数据即可</p><p>主机名和端口<br>运行于因特网上的服务器其实是某台计算器上运行的一个进程．服务器在该<br>主机拥有一个端口．主机和端口的组合才标识了一个服务器</p><p>协议<br>协议是服务器和客户之间交互的规则．每个客户&#x2F;服务器模型都必须定义一个<br>协议并遵守,只要两者相互认可就行，比如约定数据的格式等</p><p>&#x2F;etc&#x2F;services中定义了常用的服务器端口列表</p><p>socket中服务器流程：<br>１　向内核申请一个socket<br>socket是一个通信端点　系统调用socket创建一个socket<br>２ 绑定地址到socket上，地址包括主机，端口<br>bind调用把一个地址分配给socket<br>３ 在socket上，允许接入呼叫并设置队列长度<br>使用listen 监听端口<br>４　等待&#x2F;接收呼叫<br>使用accept来接收调用，accept阻塞当前进程，直到指定socket上的接入连接<br>被建立起来，然后返回文件描述符进行读写操作<br>５ 传输数据<br>６ 关闭连接<br>close系统调用</p><p>socket中客户端流程：<br>１　向内核申请建立socket<br>２ 与服务器连接<br>connect系统调用<br>３ 传送数据<br>４ 关闭连接</p><p>对于任何运行参数中所含的命令或从因特网上获取数据的服务器，在编写时都要格外<br>小心，比如收到用户参数里有”;rm *”</p><h2 id="code"><a href="#code" class="headerlink" title="code"></a>code</h2><p>使用管道实现进程间通信,bc dc计算器的实现</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * tinybc.c</span></span><br><span class="line"><span class="comment"> * a tiny calculator that uses dc to do its work</span></span><br><span class="line"><span class="comment"> * demonstrates bidirectional pipes</span></span><br><span class="line"><span class="comment"> * input looks like number op number which</span></span><br><span class="line"><span class="comment"> * tinybc converts into number \n number \n op \n p</span></span><br><span class="line"><span class="comment"> * and passes result back to stdout</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * program outline:</span></span><br><span class="line"><span class="comment"> * a. get two pipes</span></span><br><span class="line"><span class="comment"> * b. fork(get another process)</span></span><br><span class="line"><span class="comment"> * c. in the dc-to-be process,</span></span><br><span class="line"><span class="comment"> *      connect stdin and out to pipes</span></span><br><span class="line"><span class="comment"> *      then execl dc</span></span><br><span class="line"><span class="comment"> * d. in the tinybc-process, no plumbing to do</span></span><br><span class="line"><span class="comment"> *      just talk to human via normal i/o</span></span><br><span class="line"><span class="comment"> *      and send stuff via pipe</span></span><br><span class="line"><span class="comment"> * e. close pipe and dc dies</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * note: does not handle multiline answers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> oops(m,x) &#123;perror(m); exit(x);&#125;</span></span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> pid, todc[<span class="number">2</span>], fromdc[<span class="number">2</span>];            <span class="comment">// equipment</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// make two pipes</span></span><br><span class="line">    <span class="keyword">if</span> (pipe(todc) == <span class="number">-1</span> || pipe(fromdc) == <span class="number">-1</span>)</span><br><span class="line">        oops(<span class="string">&quot;pipe failed&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get a process for user interface</span></span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) == <span class="number">-1</span>)</span><br><span class="line">        oops(<span class="string">&quot;cannot fork&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)                           <span class="comment">// child is dc</span></span><br><span class="line">        be_dc(todc, fromdc);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        be_bc(todc, fromdc);                <span class="comment">// parent is ui</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">be_dc(<span class="type">int</span> in[<span class="number">2</span>], <span class="type">int</span> out[<span class="number">2</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * set up stdin and stdout, then execl dc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// setup stdin from pipein</span></span><br><span class="line">    <span class="keyword">if</span> (dup2(in[<span class="number">0</span>], <span class="number">0</span>) == <span class="number">-1</span>)              <span class="comment">// copy read end to 0</span></span><br><span class="line">        oops(<span class="string">&quot;dc:cannot redirect stdin&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    close(in[<span class="number">0</span>]);                           <span class="comment">// moved to fd 0</span></span><br><span class="line">    close(in[<span class="number">1</span>]);                           <span class="comment">// won&#x27;t write here</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup stdout from pipeout</span></span><br><span class="line">    <span class="keyword">if</span> (dup2(out[<span class="number">1</span>], <span class="number">1</span>) == <span class="number">-1</span>)              <span class="comment">// copy write end to 1</span></span><br><span class="line">        oops(<span class="string">&quot;dc:cannot redirect stdin&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    close(out[<span class="number">1</span>]);                           <span class="comment">// moved to fd 1</span></span><br><span class="line">    close(out[<span class="number">0</span>]);                           <span class="comment">// won&#x27;t read from here</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// now execl dc with the - option</span></span><br><span class="line">    execlp(<span class="string">&quot;dc&quot;</span>, <span class="string">&quot;dc&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    oops(<span class="string">&quot;Cannot run dc&quot;</span>, <span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">be_bc(<span class="type">int</span> todc[<span class="number">2</span>], <span class="type">int</span> fromdc[<span class="number">2</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * read from stdin and convert into to RPN, send down pipe</span></span><br><span class="line"><span class="comment"> * then read from other pipe and print to user</span></span><br><span class="line"><span class="comment"> * Uses fdopen() to convert a file descriptor to a stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> num1, num2;</span><br><span class="line">    <span class="type">char</span> operation[BUFSIZ], message[BUFSIZ], *fgets();</span><br><span class="line">    FILE *fpout, *fpin, *fdopen();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup</span></span><br><span class="line">    close(todc[<span class="number">0</span>]);                     <span class="comment">// won&#x27;t read from pipe to dc</span></span><br><span class="line">    close(fromdc[<span class="number">1</span>]);                     <span class="comment">// won&#x27;t write to pipe from dc</span></span><br><span class="line"></span><br><span class="line">    fpout = fdopen(todc[<span class="number">1</span>], <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fpin = fdopen(fromdc[<span class="number">0</span>], <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fpout == <span class="literal">NULL</span> || fpin == <span class="literal">NULL</span>)</span><br><span class="line">        fatal(<span class="string">&quot;Error convering pipes to streams&quot;</span>);</span><br><span class="line">    <span class="comment">// main loop</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">printf</span>(<span class="string">&quot;tinybc: &quot;</span>), fgets(message, BUFSIZ, <span class="built_in">stdin</span>) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// parse input</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">sscanf</span>(message, <span class="string">&quot;%d%[-+*/^]%d&quot;</span>,</span><br><span class="line">                    &amp;num1, operation, &amp;num2) != <span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;syntax error\n&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fprintf</span>(fpout, <span class="string">&quot;%d\n%d\n%c\np\n&quot;</span>, num1, num2, *operation) == EOF)</span><br><span class="line">            fatal(<span class="string">&quot;Error writing&quot;</span>);</span><br><span class="line"></span><br><span class="line">        fflush(fpout);</span><br><span class="line">        <span class="keyword">if</span> (fgets(message, BUFSIZ, fpin) == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d %c %d = %s&quot;</span>, num1, *operation, num2, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fpout);                  <span class="comment">// close pipe</span></span><br><span class="line">    fclose(fpin);                   <span class="comment">// dc will see EOF</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fatal(<span class="type">char</span> *mess[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: %s\n&quot;</span>, mess);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用socket实现服务器客户端远程通信</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * timeserv.c - a socket based time of day server</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strings.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORTNUM 13000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HOSTLEN 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> oops(msg)   &#123;perror(msg); exit(1);&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> ac, <span class="type">char</span> *av[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>  <span class="title">saddr</span>;</span>      <span class="comment">// build our address here</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span>  *<span class="title">hp</span>;</span>            <span class="comment">// this is part of our address</span></span><br><span class="line">    <span class="type">char</span> hostname[HOSTLEN];</span><br><span class="line">    <span class="type">int</span> sock_id, sock_fd;</span><br><span class="line">    FILE *sock_fp;</span><br><span class="line">    <span class="type">char</span> *<span class="title function_">ctime</span><span class="params">()</span>;                  <span class="comment">// convert secs to string</span></span><br><span class="line">    <span class="type">time_t</span>  thetime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step1: ask kernel for a socket</span></span><br><span class="line">    sock_id = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock_id == <span class="number">-1</span>)</span><br><span class="line">        oops(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step2: bind address to socket. Address is host, port</span></span><br><span class="line">    bzero((<span class="type">void</span> *)&amp;saddr, <span class="keyword">sizeof</span>(saddr));       <span class="comment">// clear out struct</span></span><br><span class="line"></span><br><span class="line">    gethostname(hostname, HOSTLEN);</span><br><span class="line">    hp = gethostbyname(hostname);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill in host part</span></span><br><span class="line">    bcopy((<span class="type">void</span> *)hp-&gt;h_addr, (<span class="type">void</span> *)&amp;saddr.sin_addr, hp-&gt;h_length);</span><br><span class="line">    saddr.sin_port = htons(PORTNUM);        <span class="comment">// fill in socket port</span></span><br><span class="line">    saddr.sin_family = AF_INET;             <span class="comment">// fill in addr family</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock_id, (<span class="keyword">struct</span> sockaddr *)&amp;saddr, <span class="keyword">sizeof</span>(saddr)) != <span class="number">0</span>)</span><br><span class="line">        oops(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step3: allow incoming calls with Qsize=1 on socket</span></span><br><span class="line">    <span class="keyword">if</span> (listen(sock_id, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">        oops(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// main loop: accept(), write(), close()</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sock_fd = accept(sock_id, <span class="literal">NULL</span>, <span class="literal">NULL</span>);      <span class="comment">// wait for a call</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Wow! got a call!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sock_fd == <span class="number">-1</span>)</span><br><span class="line">            oops(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line"></span><br><span class="line">        sock_fp = fdopen(sock_fd, <span class="string">&quot;w&quot;</span>);             <span class="comment">// wirte to the socket as a stream</span></span><br><span class="line">        <span class="keyword">if</span> (sock_fp == <span class="literal">NULL</span>)</span><br><span class="line">            oops(<span class="string">&quot;fdopen&quot;</span>);</span><br><span class="line"></span><br><span class="line">        thetime = time(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">fprintf</span>(sock_fp, <span class="string">&quot;The time here is ..&quot;</span>);</span><br><span class="line">        <span class="built_in">fprintf</span>(sock_fp, <span class="string">&quot;%s&quot;</span>, ctime(&amp;thetime));</span><br><span class="line"></span><br><span class="line">        fclose(sock_fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * timeclnt.c - a client for timeserv.c</span></span><br><span class="line"><span class="comment"> * usage: timeclnt hostname protnumber</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> oops(msg)   &#123;perror(msg); exit(1);&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> ac, <span class="type">char</span> *av[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>  <span class="title">servadd</span>;</span>     </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span>  *<span class="title">hp</span>;</span>            </span><br><span class="line">    <span class="type">int</span> sock_id, sock_fd;</span><br><span class="line">    <span class="type">char</span> message[BUFSIZ];</span><br><span class="line">    <span class="type">int</span> messlen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step1: get a socket</span></span><br><span class="line">    sock_id = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock_id == <span class="number">-1</span>)</span><br><span class="line">        oops(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step2: connect to server</span></span><br><span class="line">    <span class="comment">//          need to build address(host,port) of server first</span></span><br><span class="line">    bzero(&amp;servadd, <span class="keyword">sizeof</span>(servadd));       <span class="comment">// clear out struct</span></span><br><span class="line"></span><br><span class="line">    hp = gethostbyname(av[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (hp == <span class="literal">NULL</span>)</span><br><span class="line">        oops(av[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fill in host part</span></span><br><span class="line">    bcopy(hp-&gt;h_addr, (<span class="keyword">struct</span> sockaddr *)&amp;servadd.sin_addr, hp-&gt;h_length);</span><br><span class="line">    servadd.sin_port = htons(atoi(av[<span class="number">2</span>]));        <span class="comment">// fill in socket port</span></span><br><span class="line">    servadd.sin_family = AF_INET;             <span class="comment">// fill in addr family</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connect(sock_id, (<span class="keyword">struct</span> sockaddr *)&amp;servadd, <span class="keyword">sizeof</span>(servadd)) != <span class="number">0</span>)</span><br><span class="line">        oops(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step3: transfer data from server, then hangup</span></span><br><span class="line">    messlen = read(sock_id, message, BUFSIZ);</span><br><span class="line">    <span class="keyword">if</span> (messlen == <span class="number">-1</span>)</span><br><span class="line">        oops(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (write(<span class="number">1</span>, message, messlen) != messlen)</span><br><span class="line">        oops(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    close(sock_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul class="copyright-info-content"><li class="post-title"><span class="type">本文标题</span>：<span class="content">Unix-Linux编程实践教程-chapter11-socket</span></li><li class="post-author"><span class="type">本文作者</span>：<span class="content">Pin Young</span></li><li class="post-time"><span class="type">创建时间</span>：<span class="content">2016-08-03 00:51:07</span></li><li class="post-link"><span class="type">本文链接</span>：<span class="content">posts/4ef8.html</span></li><li class="post-license"><span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span></li></ul><div class="copy-copyright-info flex-center tooltip" data-content="复制版权信息" data-offset-y="-2px"><i class="fa-solid fa-copy"></i></div></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/C/">#C</a>&nbsp;</li><li class="tag-item"><a href="/tags/Linux/">#Linux</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/posts/b0ed.html"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">pyinstaller打包flask代码报错</span> <span class="post-nav-item">上一篇</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/posts/9b32.html"><span class="title flex-center"><span class="post-nav-title-item">Unix-Linux编程实践教程-chapter10-io</span> <span class="post-nav-item">下一篇</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%EF%BC%91%EF%BC%91%E7%AB%A0-%E8%BF%9E%E6%8E%A5%E5%88%B0%E8%BF%91%E7%AB%AF%E6%88%96%E8%BF%9C%E7%AB%AF%E7%9A%84%E8%BF%9B%E7%A8%8B%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8ESocket-%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="nav-number">1.</span> <span class="nav-text">第１１章　连接到近端或远端的进程：服务器与Socket(套接字)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#code"><span class="nav-number">2.</span> <span class="nav-text">code</span></a></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2014</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">Pin Young</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; 总访问量&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="theme-info info-item">由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/dstansice">零域Lite 1.3.1</a></div><script async defer data-website-id="b3b1feba-ef0f-4367-ba34-6a0152b8749b" src="https://analysis.0skyu.cn/umami.js"></script><div class="icp-info info-item"><div class="theme-info info-item"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12011002021027" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="https://0skyu.cn/beian.png" style="float:left"><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">津公网安备 12011002021027号</p></a></div><div class="theme-info info-item"><center><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">津ICP备2021004482号-1</a></center></div></div><div class="deploy-info info-item"><a target="_blank" rel="nofollow" href="https://hao.0skyu.cn/">本站由 <span class="tooltip" data-content="腾讯云"><img src="/images/deploy-provider/tencent_cloud.png"></span>提供部署服务</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item rss flex-center"><a class="flex-center" href="/atom.xml" target="_blank"><i class="fas fa-rss"></i></a></li><li class="tools-item tool-scroll-to-top flex-center"><i class="fas fa-arrow-up"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/header-shrink.js"></script><script src="/js/back2top.js"></script><script src="/js/dark-light-toggle.js"></script><script src="/js/local-search.js"></script><script src="/js/code-block.js"></script><script src="/js/lazyload.js"></script><div class="post-scripts pjax"><script src="/js/post-helper.js"></script><script src="/js/libs/anime.min.js"></script><script src="/js/toc.js"></script></div><script src="/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{window.pjax=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1}),document.addEventListener("pjax:send",()=>{KEEP.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{KEEP.utils.pjaxProgressBarEnd(),window.pjax.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),KEEP.refresh()})})</script></body></html>
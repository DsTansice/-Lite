let url=$request.url,movieId=url.match(/subject\/(\d+)/),seen=url.match(/\?seen=(\d)$/),collect=!1,region="US",tmdb_api_key="";async function douban_addons(){let e=$response.body;var t=e.match(/"sub-title">([^<]+)/),a=(t||$done({}),collect&&(e=e.replace(/<a.+pbtn.+wish.+>/,`<a href="${url}?seen=0">`)),collect&&(e=e.replace(/<a.+pbtn.+collect.+>/,`<a href="${url}?seen=1">`)),[`<div class="sub-ddgksf2013" style="background:rgba(0,0,0,0.1);border-radius:6px;padding:13px 15px;margin-top:10px"> <img src="https://files.catbox.moe/c8vszl.png" height="23" width="32" style="vertical-align: middle;"><a href="https://www.cupfox.com/search?key=${t[1]}"><span class="vendor-text" style="display: inline-block;vertical-align:middle;font-size:15px;color:#fff;margin-left:5px;">茶杯狐 👉 Click to Play 👈</span> </a></div>`]),t=(a.push(`<div class="sub-ddgksf2013" style="background:rgba(0,0,0,0.1);border-radius:6px;padding:13px 15px;margin-top:10px"> <img src="https://p0.meituan.net/dpgroup/bf54b6ae9ee149d304b3a351b4247d563960.png" height="32" width="32" style="vertical-align: middle;"><a href="https://www.libvio.me/search/-------------.html?wd=${t[1]}"><span class="vendor-text" style="display: inline-block;vertical-align:middle;font-size:15px;color:#fff;margin-left:5px;">Libvio 👉 Click to Play 👈</span> </a></div>`),movieId[1],{});if(tmdb_api_key&&("movie"==t.type||"tv"==t.type)&&t.original_title){var r=await send_request({url:`https://api.themoviedb.org/3/search/${t.type}?api_key=${tmdb_api_key}&query=${encodeURIComponent(t.original_title.replace(/Season \d+$/,""))}&page=1`,method:"GET"});if(r.results[0]){var i=await send_request({url:`https://api.themoviedb.org/3/${t.type}/${r.results[0].id}/watch/providers?api_key=`+tmdb_api_key,method:"GET"});if(i.results[region]&&i.results[region].flatrate)for(var s in i.results[region].flatrate)a.push(`<a href=""><img src="https://image.tmdb.org/t/p/original${i.results[region].flatrate[s].logo_path}" height="25" width="25" style="vertical-align: text-top;" /></a>`)}}e=e.replace(/\<div\ class\=\"sub\-vendor\"[\s\S]*?\<\/div\>/,""+a.join("\n")).replace(/<head>/,'<head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ddgksf2013/Html/douban.css" type="text/css">'),$done({body:e})}async function collect_movie(){$response&&$done({});var e=await send_request({url:`https://frodo.douban.com/api/v2/movie/${movieId[1]}?apiKey=0ac44ae016490db2204ce0a042db2916`,method:"GET",headers:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 14_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.3(0x18000323) NetType/WIFI Language/en",Referer:"https://servicewechat.com/wx2f9b06c1de1ccfca/82/page-frame.html"}});"movie_not_found"==e.msg&&($notify("豆瓣电影",data.msg,""),$done({path:url.replace(/https:\/\/m.douban.com|\/\?seen=\d/g,"")}));let t="";for(var a=0;a<e.actors.length;a++)t=t+e.actors[a].name+" / ";let r="";for(var i=0;i<e.directors.length;i++)r=r+e.directors[i].name+" / ";var s=e.title+"  "+e.original_title,o=await send_request({url:"https://api.airtable.com/v0/BASE_ID/Douban",method:"POST",headers:{Authorization:"Bearer API_KEY","Content-Type":"application/json"},body:JSON.stringify({records:[{fields:{Title:s,Description:e.intro,Poster:[{url:e.pic.large}],Seen:1==seen[1],Actors:t.replace(/\s\/\s$/,""),Director:r.replace(/\s\/\s$/,""),Genre:e.genres.toString(),Douban:"https://movie.douban.com/subject/"+movieId[1],Rating:e.rating.value,Year:e.year}}]})});o.records||($notify("收藏失败",o.error.type,o.error.message),$done({path:url.replace(/https:\/\/m.douban.com|\/\?seen=\d/g,"")})),$notify("豆瓣电影",s+" 收藏成功",""),$done({path:url.replace(/https:\/\/m.douban.com|\/\?seen=\d/g,"")})}function send_request(a){return new Promise((t,e)=>{$task.fetch(a).then(e=>{t(JSON.parse(e.body))})})}seen||douban_addons(),seen&&collect_movie();
const $=new Env("书香门第");$.signKeySXMD="usersignKeySXMD";let isGetCookie="undefined"!=typeof $request;function doTask(){return new Promise(o=>{$.post(taskUrl(),(t,e,s)=>{try{if(t)s=JSON.parse(e.body);else{var i=unescape(s).match(/messagetext">\r\n<p>.+<\/p>/g);if(s.match(/class="one">.+<\/p>/g)){$.ret=0,$.subt="Cooies失效，请点击通知重新获取！";$.msg($.name,$.subt,$.msr,{"open-url":"http://www.txtnovel.top","media-url":"https://github.com/ddgksf2013/Icon/raw/master/sxmd.png"})}else{$.ret=1,$.subt="";for(var r=i[0].match(/[\u4e00-\u9fa50-9]+/g),a=0;a<r.length;a++)$.subt=$.subt+r[a];$.subt=$.subt+"！"}}}catch(t){$.logErr(t,e)}finally{o()}})})}function doTask2(){return new Promise(r=>{$.post(taskUrl2(),(t,e,s)=>{try{var i;t?s=JSON.parse(e.body):(i=s.match(/<b>\d+<\/b><\/font>/g),$.subt=$.subt+"总金币："+i[0].match(/\d+/g)+"枚",$.msg($.name,$.subt,$.msr,{"open-url":"https://t.me/ddgksf2021","media-url":"https://github.com/ddgksf2013/Icon/raw/master/sxmd.png"}))}catch(t){$.logErr(t,e)}finally{r()}})})}function taskUrl2(){return{url:"http://www.txtnovel.top/plugin.php?id=dsu_paulsign:sign&mobile=yes",headers:{Cookie:JSON.parse($.getdata($.signKeySXMD)).headers.Cookie,"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 15_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.18(0x1800123c) NetType/WIFI Language/zh_TW"}}}function taskUrl(){return{url:"http://www.txtnovel.top/plugin.php?id=dsu_paulsign:sign&operation=qiandao&infloat=0&inajax=0&mobile=yes",body:JSON.parse($.getdata($.signKeySXMD)).body,headers:{Cookie:JSON.parse($.getdata($.signKeySXMD)).headers.Cookie,"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 15_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.18(0x1800123c) NetType/WIFI Language/zh_TW"}}}function Env(a,t){class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((i,r)=>{s.call(this,t,(t,e,s)=>{t?r(t):i(e)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`🔔${this.name}, 开始!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;if(this.getdata(t))try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(i=>{this.get({url:t},(t,e,s)=>i(s))})}runScript(a,o){return new Promise(i=>{let t=this.getdata("@chavy_boxjs_userCfgs.httpapi");t=t&&t.replace(/\n/g,"").trim();var e=(e=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout"))?+e:20,[s,r]=(e=o&&o.timeout?o.timeout:e,t.split("@"));this.post({url:`http://${r}/v1/scripting/evaluate`,body:{script_text:a,mock_type:"cron",timeout:e},headers:{"X-Key":s,Accept:"*/*"}},(t,e,s)=>i(s))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};this.fs=this.fs||require("fs"),this.path=this.path||require("path");var t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}writedata(){var t,e,s,i,r;this.isNode()&&(this.fs=this.fs||require("fs"),this.path=this.path||require("path"),t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),i=!(s=this.fs.existsSync(t))&&this.fs.existsSync(e),r=JSON.stringify(this.data),!s&&i?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r))}lodash_get(t,e,s){let i=t;for(const t of e.replace(/\[(\d+)\]/g,".$1").split("."))if(i=Object(i)[t],void 0===i)return s;return i}lodash_set(t,i,e){return Object(t)!==t||((i=Array.isArray(i)?i:i.toString().match(/[^.[\]]+/g)||[]).slice(0,-1).reduce((t,e,s)=>Object(t[e])===t[e]?t[e]:t[e]=Math.abs(i[s+1])>>0==+i[s+1]?[]:{},t)[i[i.length-1]]=e),t}getdata(t){let e=this.getval(t);if(/^@/.test(t)){var[,s,i]=/^@(.*?)\.(.*?)$/.exec(t),s=s?this.getval(s):"";if(s)try{const t=JSON.parse(s);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){var[,i,r]=/^@(.*?)\.(.*?)$/.exec(e),a=this.getval(i),a=i?"null"===a?null:a||"{}":"{}";try{const e=JSON.parse(a);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),i)}catch(e){a={};this.lodash_set(a,r,t),s=this.setval(JSON.stringify(a),i)}}else s=this.setval(t,e);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got||require("got"),this.cktough=this.cktough||require("tough-cookie"),this.ckjar=this.ckjar||new this.cktough.CookieJar,t&&(t.headers=t.headers||{},void 0===t.headers.Cookie)&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar)}get(t,r=()=>{}){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,e,s)=>{!t&&e&&(e.body=s,e.statusCode=e.status),r(t,e,s)})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;r(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>r(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{var s;t.headers["set-cookie"]&&((s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString())&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar)}catch(t){this.logErr(t)}}).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;r(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>{var{message:t,response:e}=t;r(t,e,e&&e.body)}))}post(t,r=()=>{}){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.post(t,(t,e,s)=>{!t&&e&&(e.body=s,e.statusCode=e.status),r(t,e,s)});else if(this.isQuanX())t.method="POST",this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;r(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>r(t));else if(this.isNode()){this.initGotEnv(t);const{url:e,...s}=t;this.got.post(e,s).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;r(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>{var{message:t,response:e}=t;r(t,e,e&&e.body)})}}time(t,e=null){var s,e=e?new Date(e):new Date,i={"M+":e.getMonth()+1,"d+":e.getDate(),"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(s in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),i)new RegExp("("+s+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[s]:("00"+i[s]).substr((""+i[s]).length)));return t}msg(t=a,e="",s="",i){var r=t=>{return t&&("string"==typeof t?this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0:"object"==typeof t?this.isLoon()?{openUrl:t.openUrl||t.url||t["open-url"],mediaUrl:t.mediaUrl||t["media-url"]}:this.isQuanX()?{"open-url":t["open-url"]||t.url||t.openUrl,"media-url":t["media-url"]||t.mediaUrl}:this.isSurge()?{url:t.url||t.openUrl||t["open-url"]}:void 0:void 0)};this.isMute||(this.isSurge()||this.isLoon()?$notification.post(t,e,s,r(i)):this.isQuanX()&&$notify(t,e,s,r(i))),this.isMuteLog||((r=["","==============📣系统通知📣=============="]).push(t),e&&r.push(e),s&&r.push(s),console.log(r.join("\n")),this.logs=this.logs.concat(r))}log(...t){0<t.length&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){!this.isSurge()&&!this.isQuanX()&&!this.isLoon()?this.log("",`❗️${this.name}, 错误!`,t.stack):this.log("",`❗️${this.name}, 错误!`,t)}wait(e){return new Promise(t=>setTimeout(t,e))}done(t={}){var e=((new Date).getTime()-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${e} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(a,t)}(isGetCookie?(async()=>{var t={};t.url=$request.url,t.body=$request.body,t.headers=$request.headers,$.setdata(JSON.stringify(t),$.signKeySXMD)?$.subt="获取会话:成功!":$.subt="获取会话:失败!",$.msg($.name,$.subt,"")})().catch(t=>$.logErr(t)):(async()=>{await doTask(),$.ret&&await doTask2()})().catch(t=>$.logErr(t))).finally(()=>$.done());
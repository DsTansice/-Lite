var $=new Env("ALI"),date=new Date,debug=!1,url=$request.url,host=$.getdata("alist_host"),alistUrl=$.getdata("alist_url"),refreshToken=$.getdata("aliyun_refresh_token"),accessToken=$.getdata("aliyun_access_token"),driveId=$.getdata("aliyun_drive_id"),headers={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36","Content-Type":"application/json"},myResponse={status:"HTTP/1.1 200 OK"},obj={};async function AliyunAuth(){return new Promise(a=>{var e=$request.body.match(/passwd=([^&]*)/)[1],e=$.getdata("aliyun_refresh_token")??e,e={url:"https://auth.aliyundrive.com/v2/account/token",headers:headers,body:JSON.stringify({refresh_token:e,grant_type:"refresh_token"})};$.post(e,(e,t,s)=>{try{var i=JSON.parse(s);i.refresh_token&&i.access_token&&i.default_drive_id?($.setdata(i.refresh_token,"aliyun_refresh_token"),$.setdata(i.access_token,"aliyun_access_token"),$.setdata(i.default_drive_id,"aliyun_drive_id"),debug&&(console.log("body.refresh_token:"+i.refresh_token),console.log("body.access_token:"+i.access_token),console.log("body.default_drive_id:"+i.default_drive_id)),obj={success:!0,data:{sid:i.access_token}},myResponse.body=JSON.stringify(obj),$.done(myResponse)):$.done()}catch(e){$.logErr(e,t)}finally{a()}})})}async function AliyunEntry(){return new Promise(o=>{var e=$request.body;if("string"==typeof e){if(-1!=e.indexOf("list_share")||-1!=e.indexOf("method=list")){headers.authorization="Bearer "+accessToken;const n="root"===(e=null===e.match(/folder_path=([^&]*)/)?"root":e.match(/folder_path=([^&]*)/)[1]);e=e.replace(/%25/g,"%"),e={url:"https://api.aliyundrive.com/v2/file/list",headers:headers,body:JSON.stringify({drive_id:driveId,fields:"*",parent_file_id:e,limit:200})};debug&&console.log(JSON.stringify(e)),$.post(e,(e,t,s)=>{try{-1!=s.indexOf("password")&&$.msg($.name,"","此文件夹需要密码！");var i=JSON.parse(s).items,a=[],r=(i.forEach(function(e){e={isdir:"folder"===e.type,path:e.file_id,name:e.name,additional:{size:e.size}};a.push(e)}),n?{total:0,offset:0,shares:a}:{total:0,offset:0,files:a});obj={success:!0,data:r},myResponse.body=JSON.stringify(obj),$.done(myResponse)}catch(e){$.logErr(e,t)}finally{o()}})}}else $.done()})}async function AliyunDownLoad(){return new Promise(a=>{var e=hexToUtf8(url.match(/dlink=%22(.*)%22/)[1]),e=(debug&&console.log("fileId : "+e),{drive_id:driveId,expire_sec:14400,file_id:e}),e=(headers.authorization="Bearer "+accessToken,{url:"https://api.aliyundrive.com/v2/file/get_download_url",headers:headers,body:JSON.stringify(e)});$.post(e,(e,t,s)=>{try{var i=JSON.parse(s).url;debug&&console.log(i),$.done({status:"HTTP/1.1 302 Found",headers:{Location:i}})}catch(e){$.logErr(e,t)}finally{a()}})})}async function AlistAuth(){return new Promise(e=>{var t=$request.body,t=decodeURIComponent(t.match(/account=([^&]*)/)[1]);console.log("host:"+t),$.setdata(t,"alist_host"),obj={success:!0,data:{sid:""}},myResponse.body=JSON.stringify(obj),$.done(myResponse)})}async function AlistEntry(){return new Promise(h=>{var e=$request.body;if("string"==typeof e){if(-1!=e.indexOf("list_share")||-1!=e.indexOf("method=list")){const l="/"===(d=null===e.match(/folder_path=([^&]*)/)?"/":e.match(/folder_path=([^&]*)/)[1]);var d=d.replace(/%25/g,"%"),e={page_num:1,page_size:100,password:"",path:decodeURIComponent(d)},e={url:host+"/api/public/path",headers:headers,body:JSON.stringify(e)};$.post(e,(e,t,s)=>{try{-1!=s.indexOf("password")&&$.msg($.name,"","此文件夹需要密码！");var i=JSON.parse(s).data.files;const n="/"===d?"":d;var a=[],r=[],o=("string"==typeof $.getdata("alist_url")&&(r=JSON.parse($.getdata("alist_url")),debug)&&console.log("get persistentstore data"),i.forEach(function(e){var t={isdir:1===e.type,path:n+"/"+e.name,name:e.name,additional:{size:e.size}};a.push(t),3!=e.type&&4!=e.type||(t={url:e.url,name:e.name},r.push(t),100<r.length&&r.shift())}),0<r.length&&$.setdata(JSON.stringify(r),"alist_url"),l?{total:0,offset:0,shares:a}:{total:0,offset:0,files:a});obj={success:!0,data:o},myResponse.body=JSON.stringify(obj),$.done(myResponse)}catch(e){$.logErr(e,t)}finally{h()}})}}else $.done()})}async function AlistDownLoad(){return new Promise(e=>{const t=hexToUtf8($request.url.match(/dlink=%22(.*)%22/)[1]);var s=JSON.parse($.getdata("alist_url"));debug&&console.log(t),s.forEach(function(e){-1!=encodeURIComponent(t).indexOf(encodeURIComponent(e.name))&&(e=(e=e.url)||host+"/d"+t,debug&&console.log(e),$.done({status:"HTTP/1.1 302 Found",headers:{Location:e}}))})})}function hexToUtf8(e){return decodeURIComponent("%"+e.match(/.{1,2}/g).join("%"))}function Env(r,e){class s{constructor(e){this.env=e}send(e,t="GET"){e="string"==typeof e?{url:e}:e;let s=this.get;return"POST"===t&&(s=this.post),new Promise((i,a)=>{s.call(this,e,(e,t,s)=>{e?a(e):i(t)})})}get(e){return this.send.call(this.env,e)}post(e){return this.send.call(this.env,e,"POST")}}return new class{constructor(e,t){this.name=e,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,t),this.log("",`🔔${this.name}, 开始!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(e,t=null){try{return JSON.parse(e)}catch{return t}}toStr(e,t=null){try{return JSON.stringify(e)}catch{return t}}getjson(e,t){let s=t;if(this.getdata(e))try{s=JSON.parse(this.getdata(e))}catch{}return s}setjson(e,t){try{return this.setdata(JSON.stringify(e),t)}catch{return!1}}getScript(e){return new Promise(i=>{this.get({url:e},(e,t,s)=>i(s))})}runScript(r,o){return new Promise(i=>{let e=this.getdata("@chavy_boxjs_userCfgs.httpapi");e=e&&e.replace(/\n/g,"").trim();var t=(t=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout"))?+t:20,[s,a]=(t=o&&o.timeout?o.timeout:t,e.split("@"));this.post({url:`http://${a}/v1/scripting/evaluate`,body:{script_text:r,mock_type:"cron",timeout:t},headers:{"X-Key":s,Accept:"*/*"}},(e,t,s)=>i(s))}).catch(e=>this.logErr(e))}loaddata(){if(!this.isNode())return{};this.fs=this.fs||require("fs"),this.path=this.path||require("path");var e=this.path.resolve(this.dataFile),t=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(e),i=!s&&this.fs.existsSync(t);if(!s&&!i)return{};i=s?e:t;try{return JSON.parse(this.fs.readFileSync(i))}catch(e){return{}}}writedata(){var e,t,s,i,a;this.isNode()&&(this.fs=this.fs||require("fs"),this.path=this.path||require("path"),e=this.path.resolve(this.dataFile),t=this.path.resolve(process.cwd(),this.dataFile),i=!(s=this.fs.existsSync(e))&&this.fs.existsSync(t),a=JSON.stringify(this.data),!s&&i?this.fs.writeFileSync(t,a):this.fs.writeFileSync(e,a))}lodash_get(e,t,s){let i=e;for(const e of t.replace(/\[(\d+)\]/g,".$1").split("."))if(i=Object(i)[e],void 0===i)return s;return i}lodash_set(e,i,t){return Object(e)!==e||((i=Array.isArray(i)?i:i.toString().match(/[^.[\]]+/g)||[]).slice(0,-1).reduce((e,t,s)=>Object(e[t])===e[t]?e[t]:e[t]=Math.abs(i[s+1])>>0==+i[s+1]?[]:{},e)[i[i.length-1]]=t),e}getdata(e){let t=this.getval(e);if(/^@/.test(e)){var[,s,i]=/^@(.*?)\.(.*?)$/.exec(e),s=s?this.getval(s):"";if(s)try{const e=JSON.parse(s);t=e?this.lodash_get(e,i,""):t}catch(e){t=""}}return t}setdata(e,t){let s=!1;if(/^@/.test(t)){var[,i,a]=/^@(.*?)\.(.*?)$/.exec(t),r=this.getval(i),r=i?"null"===r?null:r||"{}":"{}";try{const t=JSON.parse(r);this.lodash_set(t,a,e),s=this.setval(JSON.stringify(t),i)}catch(t){r={};this.lodash_set(r,a,e),s=this.setval(JSON.stringify(r),i)}}else s=this.setval(e,t);return s}getval(e){return this.isSurge()||this.isLoon()?$persistentStore.read(e):this.isQuanX()?$prefs.valueForKey(e):this.isNode()?(this.data=this.loaddata(),this.data[e]):this.data&&this.data[e]||null}setval(e,t){return this.isSurge()||this.isLoon()?$persistentStore.write(e,t):this.isQuanX()?$prefs.setValueForKey(e,t):this.isNode()?(this.data=this.loaddata(),this.data[t]=e,this.writedata(),!0):this.data&&this.data[t]||null}initGotEnv(e){this.got=this.got||require("got"),this.cktough=this.cktough||require("tough-cookie"),this.ckjar=this.ckjar||new this.cktough.CookieJar,e&&(e.headers=e.headers||{},void 0===e.headers.Cookie)&&void 0===e.cookieJar&&(e.cookieJar=this.ckjar)}get(e,a=()=>{}){e.headers&&(delete e.headers["Content-Type"],delete e.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(e.headers=e.headers||{},Object.assign(e.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(e,(e,t,s)=>{!e&&t&&(t.body=s,t.statusCode=t.status),a(e,t,s)})):this.isQuanX()?(this.isNeedRewrite&&(e.opts=e.opts||{},Object.assign(e.opts,{hints:!1})),$task.fetch(e).then(e=>{var{statusCode:e,statusCode:t,headers:s,body:i}=e;a(null,{status:e,statusCode:t,headers:s,body:i},i)},e=>a(e))):this.isNode()&&(this.initGotEnv(e),this.got(e).on("redirect",(e,t)=>{try{var s;e.headers["set-cookie"]&&(s=e.headers["set-cookie"].map(this.cktough.Cookie.parse).toString(),this.ckjar.setCookieSync(s,null),t.cookieJar=this.ckjar)}catch(e){this.logErr(e)}}).then(e=>{var{statusCode:e,statusCode:t,headers:s,body:i}=e;a(null,{status:e,statusCode:t,headers:s,body:i},i)},e=>{var{message:e,response:t}=e;a(e,t,t&&t.body)}))}post(e,a=()=>{}){if(e.body&&e.headers&&!e.headers["Content-Type"]&&(e.headers["Content-Type"]="application/x-www-form-urlencoded"),e.headers&&delete e.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(e.headers=e.headers||{},Object.assign(e.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.post(e,(e,t,s)=>{!e&&t&&(t.body=s,t.statusCode=t.status),a(e,t,s)});else if(this.isQuanX())e.method="POST",this.isNeedRewrite&&(e.opts=e.opts||{},Object.assign(e.opts,{hints:!1})),$task.fetch(e).then(e=>{var{statusCode:e,statusCode:t,headers:s,body:i}=e;a(null,{status:e,statusCode:t,headers:s,body:i},i)},e=>a(e));else if(this.isNode()){this.initGotEnv(e);const{url:t,...s}=e;this.got.post(t,s).then(e=>{var{statusCode:e,statusCode:t,headers:s,body:i}=e;a(null,{status:e,statusCode:t,headers:s,body:i},i)},e=>{var{message:e,response:t}=e;a(e,t,t&&t.body)})}}time(e){var t,s={"M+":(new Date).getMonth()+1,"d+":(new Date).getDate(),"H+":(new Date).getHours(),"m+":(new Date).getMinutes(),"s+":(new Date).getSeconds(),"q+":Math.floor(((new Date).getMonth()+3)/3),S:(new Date).getMilliseconds()};for(t in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,((new Date).getFullYear()+"").substr(4-RegExp.$1.length))),s)new RegExp("("+t+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?s[t]:("00"+s[t]).substr((""+s[t]).length)));return e}msg(e=r,t="",s="",i){var a=e=>{return e&&("string"==typeof e?this.isLoon()?e:this.isQuanX()?{"open-url":e}:this.isSurge()?{url:e}:void 0:"object"==typeof e?this.isLoon()?{openUrl:e.openUrl||e.url||e["open-url"],mediaUrl:e.mediaUrl||e["media-url"]}:this.isQuanX()?{"open-url":e["open-url"]||e.url||e.openUrl,"media-url":e["media-url"]||e.mediaUrl}:this.isSurge()?{url:e.url||e.openUrl||e["open-url"]}:void 0:void 0)},a=(this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,t,s,a(i)):this.isQuanX()&&$notify(e,t,s,a(i))),["","==============📣系统通知📣=============="]);a.push(e),t&&a.push(t),s&&a.push(s),console.log(a.join("\n")),this.logs=this.logs.concat(a)}log(...e){0<e.length&&(this.logs=[...this.logs,...e]),console.log(e.join(this.logSeparator))}logErr(e,t){!this.isSurge()&&!this.isQuanX()&&!this.isLoon()?this.log("",`❗️${this.name}, 错误!`,e.stack):this.log("",`❗️${this.name}, 错误!`,e)}wait(t){return new Promise(e=>setTimeout(e,t))}done(e={}){var t=((new Date).getTime()-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${t} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(e)}}(r,e)}(async()=>{"undefined"!=typeof $request?/alist.*?\/webapi\/auth\.cgi/.test($request.url)?await AlistAuth():/alist.*?webapi\/entry\.cgi/.test($request.url)?await AlistEntry():/alist.*?fbdownload/.test($request.url)?await AlistDownLoad():/aliyun.*?\/webapi\/auth\.cgi/.test($request.url)?await AliyunAuth():/aliyun.*?webapi\/entry\.cgi/.test($request.url)?await AliyunEntry():/aliyun.*?fbdownload/.test($request.url)&&await AliyunDownLoad():$.msg($.name,"","请勿手动执行本脚本！")})().catch(e=>$.logErr(e)).finally(()=>$.done());
const $=Env("限免APP");function gofans(){return new Promise((r,o)=>{var t={url:"https://api.gofans.cn/v1/m/app_records?page=1&limit=20",headers:{Origin:"https://m.gofans.cn",Accept:"application/json, text/plain, */*",Connection:"keep-alive",Referer:"https://m.gofans.cn/","Accept-Encoding":"gzip, deflate, br",Host:"api.gofans.cn","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 14_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0.1 Mobile/15E148 Safari/604.1","Accept-Language":"zh-cn"}};$.get(t,(t,e,s)=>{try{if(t)console.log(`🚫 ${arguments.callee.name.toString()} API请求失败，请检查网路
`+JSON.stringify(t));else for(var i of s=(s=JSON.parse(s).data).filter(t=>t.date==$.date&&t.updated_at>=$.last_updated_at&&0==t.price)){var a=`🛒：${i.name}
系统：${1==i.kind?"macOS":"iOS"}
价格：${i.original_price}
评分：⭐️${i.rating}分 ${i.rating_count}个评分
描述：
${i.description}
`;$.msg($.name,"",a,{"open-url":"https://gofans.cn/app/"+i.uuid,"media-url":i.icon})}}catch(t){o(`⚠️ ${arguments.callee.name.toString()} API返回结果解析出错
${t}
`+JSON.stringify(s))}finally{r()}})})}function Env(r,t){class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((i,a)=>{s.call(this,t,(t,e,s)=>{t?a(t):i(e)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`🔔${this.name}, 开始!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;if(this.getdata(t))try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(i=>{this.get({url:t},(t,e,s)=>i(s))})}runScript(r,o){return new Promise(i=>{let t=this.getdata("@chavy_boxjs_userCfgs.httpapi");t=t&&t.replace(/\n/g,"").trim();var e=(e=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout"))?+e:20,[s,a]=(e=o&&o.timeout?o.timeout:e,t.split("@"));this.post({url:`http://${a}/v1/scripting/evaluate`,body:{script_text:r,mock_type:"cron",timeout:e},headers:{"X-Key":s,Accept:"*/*"}},(t,e,s)=>i(s))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};this.fs=this.fs||require("fs"),this.path=this.path||require("path");var t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}writedata(){var t,e,s,i,a;this.isNode()&&(this.fs=this.fs||require("fs"),this.path=this.path||require("path"),t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),i=!(s=this.fs.existsSync(t))&&this.fs.existsSync(e),a=JSON.stringify(this.data),!s&&i?this.fs.writeFileSync(e,a):this.fs.writeFileSync(t,a))}lodash_get(t,e,s=void 0){let i=t;for(const a of e.replace(/\[(\d+)\]/g,".$1").split("."))if(void 0===(i=Object(i)[a]))return s;return i}lodash_set(t,i,e){return Object(t)===t&&((i=Array.isArray(i)?i:i.toString().match(/[^.[\]]+/g)||[]).slice(0,-1).reduce((t,e,s)=>Object(t[e])===t[e]?t[e]:t[e]=Math.abs(i[s+1])>>0==+i[s+1]?[]:{},t)[i[i.length-1]]=e),t}getdata(t){let e=this.getval(t);if(/^@/.test(t)){var[,t,s]=/^@(.*?)\.(.*?)$/.exec(t),t=t?this.getval(t):"";if(t)try{var i=JSON.parse(t);e=i?this.lodash_get(i,s,""):e}catch(t){e=""}}return e}setdata(e,t){let s=!1;if(/^@/.test(t)){var[,i,a]=/^@(.*?)\.(.*?)$/.exec(t),r=this.getval(i),r=i?"null"===r?null:r||"{}":"{}";try{var o=JSON.parse(r);this.lodash_set(o,a,e),s=this.setval(JSON.stringify(o),i)}catch(t){r={};this.lodash_set(r,a,e),s=this.setval(JSON.stringify(r),i)}}else s=this.setval(e,t);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got||require("got"),this.cktough=this.cktough||require("tough-cookie"),this.ckjar=this.ckjar||new this.cktough.CookieJar,t&&(t.headers=t.headers||{},void 0===t.headers.Cookie)&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar)}get(t,a=()=>{}){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,e,s)=>{!t&&e&&(e.body=s,e.statusCode=e.status),a(t,e,s)})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;a(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>a(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{var s;t.headers["set-cookie"]&&((s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString())&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar)}catch(t){this.logErr(t)}}).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;a(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>{var{message:t,response:e}=t;a(t,e,e&&e.body)}))}post(t,a=()=>{}){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.post(t,(t,e,s)=>{!t&&e&&(e.body=s,e.statusCode=e.status),a(t,e,s)});else if(this.isQuanX())t.method="POST",this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;a(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>a(t));else if(this.isNode()){this.initGotEnv(t);const{url:e,...s}=t;this.got.post(e,s).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;a(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>{var{message:t,response:e}=t;a(t,e,e&&e.body)})}}time(t,e){var s,i={"M+":(e=e||new Date).getMonth()+1,"d+":e.getDate(),"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(s in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),i)new RegExp("("+s+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[s]:("00"+i[s]).substr((""+i[s]).length)));return t}msg(t=r,e="",s="",i){var a=t=>{return t&&("string"==typeof t?this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0:"object"==typeof t?this.isLoon()?{openUrl:t.openUrl||t.url||t["open-url"],mediaUrl:t.mediaUrl||t["media-url"]}:this.isQuanX()?{"open-url":t["open-url"]||t.url||t.openUrl,"media-url":t["media-url"]||t.mediaUrl}:this.isSurge()?{url:t.url||t.openUrl||t["open-url"]}:void 0:void 0)};this.isMute||(this.isSurge()||this.isLoon()?$notification.post(t,e,s,a(i)):this.isQuanX()&&$notify(t,e,s,a(i))),this.isMuteLog||((a=["","==============📣系统通知📣=============="]).push(t),e&&a.push(e),s&&a.push(s),console.log(a.join("\n")),this.logs=this.logs.concat(a))}log(...t){0<t.length&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){!this.isSurge()&&!this.isQuanX()&&!this.isLoon()?this.log("",`❗️${this.name}, 错误!`,t.stack):this.log("",`❗️${this.name}, 错误!`,t)}wait(e){return new Promise(t=>setTimeout(t,e))}done(t={}){var e=((new Date).getTime()-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${e} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(r,t)}$.date=$.time("yyyyMMdd"),$.last_updated_at=$.getdata("last_updated_at")||0,console.log($.name+" 上次运行时间:"+$.time("yyyy-MM-dd HH:mm:ss",new Date(1e3*$.last_updated_at))),(async()=>{await gofans(),$.setdata(""+Date.now()/1e3,"last_updated_at")})().catch(t=>{console.log(`❗️ ${$.name} 运行错误！
`+t)}).finally(()=>$.done());
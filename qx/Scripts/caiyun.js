const SCRIPT_NAME="彩云天气",USER_REGEX=/https?:\/\/biz\.caiyunapp\.com\/v2\/user/,RIGHTS_REGEX=/https?:\/\/biz\.caiyunapp\.com\/membership_rights/,RESULT={is_vip:!0,vip_type:"s",svip_expired_at:1882066669.945295},RESULT_WT={vip:{enable:!0,svip_expired_at:1882066669.945295}},RIGHTS={result:[{name:"免广告",enabled:!0,vip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/vip-ads-free.png",vip:!0,svip:!0,_id:"5ee5eb091d28d2634a2ee08f",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-ads-free.png"},{name:"多地天气推送",enabled:!0,vip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/vip-custom-push.png",vip:!0,svip:!0,_id:"5ee5eb091d28d2634a2ee090",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-custom-push.png"},{name:"降水提醒",enabled:!0,vip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/vip-rain-notification.png",vip:!0,svip:!0,_id:"5ee5eb091d28d2634a2ee091",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-rain-notification.png"},{name:"卫星云图",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee092",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-satellite-clouds.png"},{name:"云量",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee093",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-cloud-cover.png"},{name:"气温预报",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee094",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-tmp-forecast.png"},{name:"露点温度预报",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee095",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-dew-point-tmp-forecast.png"},{name:"短波辐射通量",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee096",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-short-wave-radiation.png"},{name:"气压",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee097",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-pressure.png"},{name:"能见度",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee098",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-visibility.png"},{name:"湿度预报",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee099",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-humidity-forecast.png"},{name:"2天降雨预报图",enabled:!0,vip_icon:null,vip:!1,svip:!0,_id:"5ee5eb091d28d2634a2ee09a",svip_icon:"https://cdn.caiyunapp.com/ad/img/membership_rights/svip-rain-forecast.png"}],rc:0};let magicJS=MagicJS(SCRIPT_NAME);function Main(){if(magicJS.isResponse){if(USER_REGEX.test(magicJS.request.url))try{var e=JSON.parse(magicJS.response.body),i=(Object.assign(e.result,RESULT),Object.assign(e.result.wt,RESULT_WT),JSON.stringify(e));magicJS.done({body:i})}catch(e){magicJS.log("解锁SVIP失败，异常信息"+e),magicJS.done()}RIGHTS_REGEX.test(magicJS.request.url)&&(e=JSON.stringify(RIGHTS),magicJS.done({body:e}))}}function MagicJS(e="MagicJS",i="INFO"){return new class{constructor(){if(this.scriptName=e,this.logLevel=this.getLogLevels(i.toUpperCase()),this.node={request:void 0,fs:void 0,data:{}},this.isNode){this.node.fs=require("fs"),this.node.request=require("request");try{this.node.fs.accessSync("./magic.json")}catch(e){this.logError(e),this.node.fs.writeFileSync("./magic.json","{}")}this.node.data=require("./magic.json")}this.isJSBox&&($file.exists("drive://MagicJS")||$file.mkdir("drive://MagicJS"),$file.exists("drive://MagicJS/magic.json")||$file.write({data:$data({string:"{}"}),path:"drive://MagicJS/magic.json"}))}get version(){return"v2.1.4"}get isSurge(){return"undefined"!=typeof $httpClient&&!this.isLoon}get isQuanX(){return"undefined"!=typeof $task}get isLoon(){return"undefined"!=typeof $loon}get isJSBox(){return"undefined"!=typeof $drive}get isNode(){return"undefined"!=typeof module&&!this.isJSBox}get isRequest(){return"undefined"!=typeof $request&&"undefined"==typeof $response}get isResponse(){return"undefined"!=typeof $response}get request(){return"undefined"!=typeof $request?$request:void 0}get response(){if("undefined"!=typeof $response)return $response.hasOwnProperty("status")&&($response.statusCode=$response.status),$response.hasOwnProperty("statusCode")&&($response.status=$response.statusCode),$response}get logLevels(){return{DEBUG:4,INFO:3,WARNING:2,ERROR:1,CRITICAL:0}}getLogLevels(i){try{var e;return this.isNumber(i)?i:void 0===(e=this.logLevels[i])?(this.logError(`获取MagicJS日志级别错误，已强制设置为DEBUG级别。传入日志级别：${i}。`),this.logLevels.DEBUG):e}catch(e){return this.logError(`获取MagicJS日志级别错误，已强制设置为DEBUG级别。传入日志级别：${i}，异常信息：${e}。`),this.logLevels.DEBUG}}read(i,t=""){let s="";this.isSurge||this.isLoon?s=$persistentStore.read(i):this.isQuanX?s=$prefs.valueForKey(i):this.isNode?s=this.node.data:this.isJSBox&&(s=$file.read("drive://MagicJS/magic.json").string);try{this.isNode&&(s=s[i]),this.isJSBox&&(s=JSON.parse(s)[i]),t&&(s=(s="string"==typeof s?JSON.parse(s):s)&&"object"==typeof s?s[t]:null)}catch(e){this.logError("raise exception: "+e),s=t?{}:null,this.del(i)}void 0===s&&(s=null);try{s&&"string"==typeof s&&(s=JSON.parse(s))}catch(e){}return this.logDebug(`read data [${i}]${t?`[${t}]`:""}(${typeof s})
`+JSON.stringify(s)),s}write(i,e,t=""){let s=t?{}:"";if(t&&(this.isSurge||this.isLoon)?s=$persistentStore.read(i):t&&this.isQuanX?s=$prefs.valueForKey(i):this.isNode?s=this.node.data:this.isJSBox&&(s=JSON.parse($file.read("drive://MagicJS/magic.json").string)),t){try{s="object"==typeof(s="string"==typeof s?JSON.parse(s):s)&&s?s:{}}catch(e){this.logError("raise exception: "+e),this.del(i),s={}}this.isJSBox||this.isNode?(s.hasOwnProperty(i)&&"object"==typeof s[i]||(s[i]={}),s[i].hasOwnProperty(t)||(s[i][t]=null),void 0===e?delete s[i][t]:s[i][t]=e):void 0===e?delete s[t]:s[t]=e}else this.isNode||this.isJSBox?void 0===e?delete s[i]:s[i]=e:s=void 0===e?null:e;"object"==typeof s&&(s=JSON.stringify(s)),this.isSurge||this.isLoon?$persistentStore.write(s,i):this.isQuanX?$prefs.setValueForKey(s,i):this.isNode?this.node.fs.writeFileSync("./magic.json",s):this.isJSBox&&$file.write({data:$data({string:s}),path:"drive://MagicJS/magic.json"}),this.logDebug(`write data [${i}]${t?`[${t}]`:""}(${typeof e})
`+JSON.stringify(e))}del(e,i=""){this.logDebug(`delete key [${e}]`+(i?`[${i}]`:"")),this.write(e,void 0,i)}notify(e=this.scriptName,i="",t="",s=""){s=(e=>{let i="";return"string"==typeof e?this.isLoon?i=e:this.isQuanX&&(i={"open-url":e}):"object"==typeof e&&(this.isLoon?i=e["open-url"]||"":this.isQuanX&&(i=e["open-url"]||e["media-url"]?e:{})),i})(s),1==arguments.length&&(e=this.scriptName,i="",t=arguments[0]),this.isSurge?$notification.post(e,i,t):this.isLoon?(this.logInfo(`title: ${e}, subTitle：${i}, body：${t}, options：`+s),s?$notification.post(e,i,t,s):$notification.post(e,i,t)):this.isQuanX?$notify(e,i,t,s):this.isNode?this.log(e+` ${i}
`+t):this.isJSBox&&$push.schedule({title:e,body:i?i+`
`+t:t})}log(e,i="INFO"){this.logLevel>=this.getLogLevels(i.toUpperCase())&&console.log(`[${i}] [${this.scriptName}]
${e}
`)}logDebug(e){this.log(e,"DEBUG")}logInfo(e){this.log(e,"INFO")}logWarning(e){this.log(e,"WARNING")}logError(e){this.log(e,"ERROR")}get(e,s){let i="object"==typeof e?Object.assign({},e):e;if(this.logDebug("http get: "+JSON.stringify(i)),this.isSurge||this.isLoon)$httpClient.get(i,s);else if(this.isQuanX)(i="string"==typeof i?{url:i}:i).method="GET",$task.fetch(i).then(e=>{e.status=e.statusCode,s(null,e,e.body)},e=>s(e.error,null,null));else{if(this.isNode)return this.node.request.get(i,s);this.isJSBox&&(i="string"==typeof i?{url:i}:i,e.header=i.headers,delete i.headers,i.handler=e=>{var i=e.error?JSON.stringify(e.error):void 0,t="object"==typeof e.data?JSON.stringify(e.data):e.data;s(i,e.response,t)},$http.get(i))}}post(e,s){let i="object"==typeof e?Object.assign({},e):e;if(this.logDebug("http post: "+JSON.stringify(i)),this.isSurge||this.isLoon)$httpClient.post(i,s);else if(this.isQuanX)(i="string"==typeof i?{url:i}:i).hasOwnProperty("body")&&"string"!=typeof i.body&&(i.body=JSON.stringify(i.body)),i.method="POST",$task.fetch(i).then(e=>{e.status=e.statusCode,s(null,e,e.body)},e=>{s(e.error,null,null)});else{if(this.isNode)return"object"==typeof i.body&&(i.body=JSON.stringify(i.body)),this.node.request.post(i,s);this.isJSBox&&((i="string"==typeof i?{url:i}:i).header=i.headers,delete i.headers,i.handler=e=>{var i=e.error?JSON.stringify(e.error):void 0,t="object"==typeof e.data?JSON.stringify(e.data):e.data;s(i,e.response,t)},$http.post(i))}}done(e={}){"undefined"!=typeof $done&&$done(e)}isToday(e){var i;return null!=e&&(i=new Date,"string"==typeof e&&(e=new Date(e)),i.getFullYear()==e.getFullYear())&&i.getMonth()==e.getMonth()&&i.getDay()==e.getDay()}isNumber(e){return"NaN"!==parseFloat(e).toString()}attempt(e,i=null){return e.then(e=>[null,e]).catch(e=>(this.log("raise exception:"+e),[e,i]))}retry(o,r=5,p=0,a=null){return(...e)=>new Promise((t,s)=>{function n(...i){Promise.resolve().then(()=>o.apply(this,i)).then(e=>{"function"==typeof a?Promise.resolve().then(()=>a(e)).then(()=>{t(e)}).catch(e=>{1<=r&&0<p?setTimeout(()=>n.apply(this,i),p):1<=r?n.apply(this,i):s(e),r--}):t(e)}).catch(e=>{1<=r&&0<p?setTimeout(()=>n.apply(this,i),p):1<=r?n.apply(this,i):s(e),r--})}n.apply(this,e)})}formatTime(e,i="yyyy-MM-dd hh:mm:ss"){var t,s={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(t in/(y+)/.test(i)&&(i=i.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),s)new RegExp("("+t+")").test(i)&&(i=i.replace(RegExp.$1,1==RegExp.$1.length?s[t]:("00"+s[t]).substr((""+s[t]).length)));return i}now(){return this.formatTime(new Date,"yyyy-MM-dd hh:mm:ss")}sleep(i){return new Promise(e=>setTimeout(e,i))}}(e)}Main();